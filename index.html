<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESE Inventory System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, increment, serverTimestamp, setLogLevel, getDoc, getDocs, deleteDoc, addDoc, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables
        let app, auth, db, userId;
        let inventoryData = {};
        let transactionsData = [];
        let studentSrMap = {};
        let currentItemToEdit = null;

        // Custom message box for UI feedback
        function showMessage(message, type = 'info', messageBoxId = 'message-box') {
            const messageBox = document.getElementById(messageBoxId);
            if (!messageBox) return;

            messageBox.textContent = message;
            messageBox.className = `p-4 mt-4 rounded-lg text-center font-semibold transition-all duration-300 transform ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'} scale-100 opacity-100`;
            setTimeout(() => {
                messageBox.className = `p-4 mt-4 rounded-lg text-center font-semibold transition-all duration-300 transform ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'} scale-95 opacity-0`;
            }, 3000);
        }

        // Custom confirmation modal
        function showConfirmationModal(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const messageText = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirm-yes');
            const cancelBtn = document.getElementById('confirm-no');

            messageText.textContent = message;
            modal.classList.remove('hidden');

            const handleConfirm = () => {
                modal.classList.add('hidden');
                onConfirm();
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }
        
        // Function to switch between different views
        function switchView(viewId) {
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            // Update active navigation link styling
            document.querySelectorAll('nav button').forEach(button => {
                button.classList.remove('bg-indigo-700', 'text-white');
            });
            const activeLink = document.querySelector(`[data-view-id="${viewId}"]`);
            if (activeLink) {
                activeLink.classList.add('bg-indigo-700', 'text-white');
            }
        }

        async function initializeFirebase() {
            try {
                setLogLevel('debug');
                
                // Use the Firebase config provided by the Canvas environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

                const firebaseConfig = firebaseConfigFromCanvas || {
                    apiKey: "AIzaSyCKLZ3BWAl0Z48H0dnprdtn2cTQ7jKlTOg",
                    authDomain: "deseinventory.firebaseapp.com",
                    projectId: "deseinventory",
                    storageBucket: "deseinventory.firebasestorage.app",
                    messagingSenderId: "765936216501",
                    appId: "1:765936216501:web:972c9f9355ca638d81d1fc",
                    measurementId: "G-M2STNJYRP9"
                };

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                
                startRealtimeListeners(appId);
                showMessage("Database connected successfully!", "success");
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Failed to connect to the database. Check the console for errors.", "error");
            }
        }

        // Renders the inventory table based on the provided data
        function renderInventoryTable(data) {
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            
            if (data.length === 0) {
                inventoryList.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No matching items found.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors duration-200';
                row.innerHTML = `
                    <td class="p-4">${item.name || 'N/A'}</td>
                    <td class="p-4">${item.partNumber || 'N/A'}</td>
                    <td class="p-4">${item.package || 'N/A'}</td>
                    <td class="p-4 text-center font-bold text-green-600">${item.stockIn || 0}</td>
                    <td class="p-4 text-center font-bold text-red-600">${item.stockOut || 0}</td>
                    <td class="p-4 text-center font-bold text-indigo-700">${item.totalQuantity || 0}</td>
                    <td class="p-4 text-sm text-gray-500">${item.lastUpdated?.toDate().toLocaleString() || 'N/A'}</td>
                    <td class="p-4 text-center">
                        <button class="edit-btn px-4 py-2 bg-yellow-500 text-white font-semibold rounded-full shadow-md hover:bg-yellow-600 transition-colors duration-200" data-item-id="${item.barcode}"><i class="fas fa-edit mr-2"></i>Edit</button>
                    </td>
                `;
                inventoryList.appendChild(row);
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemId = event.target.dataset.itemId;
                    const item = inventoryData[itemId];
                    if (item) {
                        currentItemToEdit = item;
                        populateEditForm(item);
                        switchView('edit-view');
                    }
                });
            });
        }

        function populateEditForm(item) {
            document.getElementById('edit-item-name').value = item.name || '';
            document.getElementById('edit-part-number').value = item.partNumber || '';
            document.getElementById('edit-package').value = item.package || '';
            document.getElementById('edit-quantity').value = item.totalQuantity || 0;
            document.getElementById('edit-item-name').focus();
        }

        async function handleEditForm(event) {
            event.preventDefault();
            if (!currentItemToEdit) {
                showMessage("No item selected for editing.", "error", 'message-box-edit');
                return;
            }

            const newName = document.getElementById('edit-item-name').value.trim();
            const newPartNumber = document.getElementById('edit-part-number').value.trim();
            const newPackage = document.getElementById('edit-package').value.trim();
            const newQuantity = parseInt(document.getElementById('edit-quantity').value.trim(), 10);
            
            if (!newName || !newPartNumber || !newPackage || isNaN(newQuantity) || newQuantity < 0) {
                showMessage("Invalid input. Please fill out all fields correctly.", "error", 'message-box-edit');
                return;
            }

            if (!db || !auth.currentUser) {
                showMessage("Database not connected or user not authenticated. Please refresh the page.", "error", 'message-box-edit');
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const oldBarcode = currentItemToEdit.barcode;
            const newBarcode = `${newName.replace(/\s/g, '').toLowerCase()}-${newPartNumber.replace(/\s/g, '').toLowerCase()}-${newPackage.replace(/\s/g, '').toLowerCase()}`;

            try {
                if (oldBarcode !== newBarcode) {
                    const newRef = doc(db, `artifacts/${appId}/public/data/inventory`, newBarcode);
                    await setDoc(newRef, {
                        ...currentItemToEdit,
                        barcode: newBarcode,
                        name: newName,
                        partNumber: newPartNumber,
                        package: newPackage,
                        totalQuantity: newQuantity,
                        lastUpdated: serverTimestamp()
                    });
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/inventory`, oldBarcode));
                } else {
                    const itemRef = doc(db, `artifacts/${appId}/public/data/inventory`, oldBarcode);
                    await updateDoc(itemRef, {
                        name: newName,
                        partNumber: newPartNumber,
                        package: newPackage,
                        totalQuantity: newQuantity,
                        lastUpdated: serverTimestamp()
                    });
                }

                showMessage("Item updated successfully!", "success", 'message-box-edit');
                currentItemToEdit = null;
                document.getElementById('edit-form').reset();
                switchView('inventory-view');
            } catch (e) {
                console.error("Error updating item:", e);
                showMessage(`Error updating item. Check console for details.`, "error", 'message-box-edit');
            }
        }
        
        // Listen for real-time inventory and transaction updates
        function startRealtimeListeners(appId) {
            if (!db || !appId) {
                console.error("Database or App ID not available for listeners.");
                return;
            }
            const inventoryCollectionRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            onSnapshot(inventoryCollectionRef, (querySnapshot) => {
                inventoryData = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    inventoryData[data.barcode] = data;
                });
                renderInventoryTable(Object.values(inventoryData));
            }, (error) => {
                console.error("Failed to fetch real-time inventory updates:", error);
                showMessage("Failed to sync inventory. Please refresh.", "error");
            });

            const transactionsCollectionRef = collection(db, `artifacts/${appId}/public/data/transactions`);
            onSnapshot(transactionsCollectionRef, (querySnapshot) => {
                transactionsData = [];
                studentSrMap = {}; // Reset the map
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactionsData.push({id: doc.id, ...data});
                    
                    if (data.type === 'out' && data.studentName) {
                        studentSrMap[data.studentName.toLowerCase()] = data.srNumber;
                    }
                });
                renderTransactionsTable();
            }, (error) => {
                console.error("Failed to fetch real-time transaction updates:", error);
                showMessage("Failed to sync transactions. Please refresh.", "error");
            });
        }
        
        // Render the transactions table
        function renderTransactionsTable(dataToRender = transactionsData) {
            const transactionsList = document.getElementById('transactions-list');
            transactionsList.innerHTML = '';
            
            const sortedTransactions = dataToRender.filter(t => t.type === 'out').sort((a, b) => b.timestamp - a.timestamp);
            
            if (sortedTransactions.length === 0) {
                transactionsList.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">No matching transactions found.</td></tr>';
                return;
            }

            sortedTransactions.forEach(transaction => {
                const isReturned = transaction.isReturned || false;
                const rowClass = isReturned ? 'bg-green-50/50' : 'bg-red-50/50';
                const buttonClass = isReturned ? 'opacity-50 cursor-not-allowed' : '';
                const buttonDisabled = isReturned ? 'disabled' : '';

                const row = document.createElement('tr');
                row.className = `border-b border-gray-200 ${rowClass} hover:bg-gray-50 transition-colors duration-200`;
                row.innerHTML = `
                    <td class="p-4">${transaction.studentName || 'N/A'}</td>
                    <td class="p-4">${transaction.srNumber || 'N/A'}</td>
                    <td class="p-4">${transaction.name || 'N/A'}</td>
                    <td class="p-4">${transaction.partNumber || 'N/A'}</td>
                    <td class="p-4">${transaction.package || 'N/A'}</td>
                    <td class="p-4 text-center font-bold">${transaction.quantity || 0}</td>
                    <td class="p-4 text-sm text-gray-500">${transaction.timestamp?.toDate().toLocaleString() || 'N/A'}</td>
                    <td class="p-4 text-center font-bold">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${isReturned ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">${isReturned ? 'Returned' : 'Pending'}</span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="returnItem('${transaction.id}')" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-full shadow-md hover:bg-purple-600 transition-colors duration-200 ${buttonClass}" ${buttonDisabled}><i class="fas fa-undo mr-2"></i>Return</button>
                    </td>
                `;
                transactionsList.appendChild(row);
            });
        }
        
        // --- NEW RETURN LOGIC ---
        async function returnItem(transactionId) {
            if (!db || !auth.currentUser) {
                showMessage("Database not connected or user not authenticated. Please refresh the page.", "error");
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            try {
                await runTransaction(db, async (transaction) => {
                    const transactionRef = doc(db, `artifacts/${appId}/public/data/transactions`, transactionId);
                    const transactionDoc = await transaction.get(transactionRef);

                    if (!transactionDoc.exists()) {
                        throw new Error("Transaction document not found.");
                    }
                    
                    const transactionData = transactionDoc.data();
                    if (transactionData.isReturned) {
                        throw new Error("This item has already been returned.");
                    }
                    
                    const itemBarcode = transactionData.barcode;
                    const itemRef = doc(db, `artifacts/${appId}/public/data/inventory`, itemBarcode);
                    const itemDoc = await transaction.get(itemRef);

                    if (!itemDoc.exists()) {
                        throw new Error("Corresponding inventory item not found.");
                    }

                    const quantityToReturn = transactionData.quantity;

                    // Update inventory: increment quantity
                    transaction.update(itemRef, {
                        totalQuantity: increment(quantityToReturn),
                        stockOut: increment(-quantityToReturn), // Decrease stock out count
                        lastUpdated: serverTimestamp()
                    });

                    // Update transaction record: mark as returned
                    transaction.update(transactionRef, {
                        isReturned: true,
                        returnedAt: serverTimestamp()
                    });
                });

                showMessage("Item returned successfully!", "success");
            } catch (e) {
                console.error("Error during return transaction:", e);
                showMessage(`Error returning item: ${e.message}`, "error");
            }
        }
        // --- END OF NEW RETURN LOGIC ---

        // --- NEW LOGIC FOR STUDENT NAME AUTO-FILL ---
        function handleStudentNameInput(event) {
            const typedName = event.target.value.trim().toLowerCase();
            const srNumberInput = document.getElementById('stock-out-sr-number');
            const studentMessage = document.getElementById('student-autofill-message');

            if (typedName.length > 0) {
                const existingSrNumber = studentSrMap[typedName];
                if (existingSrNumber) {
                    srNumberInput.value = existingSrNumber;
                    srNumberInput.disabled = true;
                    srNumberInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    srNumberInput.classList.add('bg-blue-100', 'cursor-default');
                    studentMessage.textContent = 'SR Number auto-filled from history.';
                    studentMessage.className = 'text-green-600 font-semibold';
                } else {
                    srNumberInput.value = '';
                    srNumberInput.disabled = false;
                    srNumberInput.classList.remove('bg-blue-100', 'cursor-default');
                    srNumberInput.classList.add('bg-gray-50');
                    studentMessage.textContent = 'New student. Please enter SR Number.';
                    studentMessage.className = 'text-yellow-600 font-semibold';
                }
            } else {
                srNumberInput.value = '';
                srNumberInput.disabled = true;
                srNumberInput.classList.remove('bg-blue-100', 'cursor-default');
                srNumberInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                studentMessage.textContent = '';
            }
        }

        // --- NEW LOGIC FOR STOCK-OUT FORM ---
        function handleItemNameInput(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            const partNumberInput = document.getElementById('stock-out-part-number');
            const packageInput = document.getElementById('stock-out-package');
            const suggestionsContainer = document.getElementById('item-suggestions');
            const messageBox = document.getElementById('autofill-message-stock-out');

            partNumberInput.value = '';
            packageInput.value = '';
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            messageBox.textContent = '';
            
            if (searchTerm.length === 0) return;

            const matches = Object.values(inventoryData).filter(item => 
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.partNumber && item.partNumber.toLowerCase().includes(searchTerm))
            );
            
            if (matches.length === 1) {
                const item = matches[0];
                document.getElementById('stock-out-item-name').value = item.name || '';
                partNumberInput.value = item.partNumber || '';
                packageInput.value = item.package || '';
                messageBox.textContent = 'Item found! Part number and package autofilled.';
                messageBox.className = 'text-green-600 font-semibold';
            } else if (matches.length > 1) {
                messageBox.textContent = 'Multiple items found. Please select from the list.';
                messageBox.className = 'text-yellow-600 font-semibold';
                suggestionsContainer.classList.remove('hidden');
                
                matches.forEach(item => {
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.className = 'flex justify-between items-center p-3 border-b border-gray-200 hover:bg-gray-100 transition-colors duration-200 cursor-pointer rounded-xl';
                    suggestionDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Part Number: ${item.partNumber || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Package: ${item.package || 'N/A'}</p>
                        </div>
                        <button type="button" class="select-btn px-4 py-2 bg-indigo-500 text-white font-semibold rounded-full hover:bg-indigo-600 transition-colors duration-200"
                                data-item-name="${item.name}" data-part-number="${item.partNumber}" data-package="${item.package}">Select</button>
                    `;
                    suggestionsContainer.appendChild(suggestionDiv);
                });
                
                document.querySelectorAll('.select-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const selectedItemName = e.target.dataset.itemName;
                        const selectedPartNumber = e.target.dataset.partNumber;
                        const selectedPackage = e.target.dataset.package;

                        document.getElementById('stock-out-item-name').value = selectedItemName;
                        partNumberInput.value = selectedPartNumber;
                        packageInput.value = selectedPackage;
                        suggestionsContainer.classList.add('hidden');
                        messageBox.textContent = 'Item selected. You can now proceed.';
                        messageBox.className = 'text-green-600 font-semibold';
                    });
                });
            } else {
                messageBox.textContent = 'No item found with this name.';
                messageBox.className = 'text-red-600 font-semibold';
            }
        }
        // --- END OF NEW LOGIC ---

        // General function to handle all stock updates (in and out)
        async function updateInventory(name, studentName, srNumber, partNumber, packageValue, quantity, action, messageBoxId) {
            if (!name || !partNumber || !packageValue || isNaN(quantity) || quantity <= 0) {
                showMessage("Invalid item name, part number, package, or quantity.", "error", messageBoxId);
                return;
            }
            if (!db || !auth.currentUser) {
                showMessage("Database not connected or user not authenticated. Please refresh the page.", "error", messageBoxId);
                return;
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const barcode = `${name.replace(/\s/g, '').toLowerCase()}-${partNumber.replace(/\s/g, '').toLowerCase()}-${packageValue.replace(/\s/g, '').toLowerCase()}`;
            const displayBarcode = "N/A";
            const itemRef = doc(db, `artifacts/${appId}/public/data/inventory`, barcode);
            
            try {
                const itemDoc = await getDoc(itemRef);
                const currentQuantity = itemDoc.exists() ? itemDoc.data().totalQuantity : 0;
                
                if (action === 'out' && quantity > currentQuantity) {
                    showMessage(`Error: Cannot stock out ${quantity} units. Only ${currentQuantity} are available.`, "error", messageBoxId);
                    return;
                }

                const updateData = {
                    totalQuantity: increment(action === 'in' ? quantity : -quantity),
                    lastUpdated: serverTimestamp(),
                    lastStockIn: action === 'in' ? serverTimestamp() : itemDoc.data()?.lastStockIn,
                    lastStockOut: action === 'out' ? serverTimestamp() : itemDoc.data()?.lastStockOut,
                    displayBarcode: displayBarcode
                };

                if (action === 'in') {
                    updateData.stockIn = increment(quantity);
                    if (name) updateData.name = name;
                    if (partNumber) updateData.partNumber = partNumber;
                    if (packageValue) updateData.package = packageValue;
                } else {
                    updateData.stockOut = increment(quantity);
                    if (name) updateData.name = name;
                    if (partNumber) updateData.partNumber = partNumber;
                    if (packageValue) updateData.package = packageValue;
                }

                if (itemDoc.exists()) {
                    await updateDoc(itemRef, updateData);
                } else {
                    const newDoc = {
                        barcode: barcode,
                        displayBarcode: displayBarcode,
                        name: name,
                        partNumber: partNumber,
                        package: packageValue,
                        totalQuantity: quantity,
                        stockIn: action === 'in' ? quantity : 0,
                        stockOut: action === 'out' ? quantity : 0,
                        lastStockIn: action === 'in' ? serverTimestamp() : null,
                        lastStockOut: action === 'out' ? serverTimestamp() : null,
                        lastUpdated: serverTimestamp()
                    };
                    await setDoc(itemRef, newDoc);
                }

                const transactionDoc = {
                    type: action,
                    barcode: barcode,
                    displayBarcode: displayBarcode,
                    name: name,
                    partNumber: partNumber,
                    package: packageValue,
                    quantity: quantity,
                    timestamp: serverTimestamp(),
                    userId: auth.currentUser.uid,
                    studentName: action === 'out' ? (studentName || 'N/A') : 'N/A',
                    srNumber: action === 'out' ? (srNumber || 'N/A') : 'N/A',
                    isReturned: false // New field to track returns
                };
                const transactionsCollectionRef = collection(db, `artifacts/${appId}/public/data/transactions`);
                await addDoc(transactionsCollectionRef, transactionDoc);

                showMessage(`Stock ${action === 'in' ? 'In' : 'Out'} successful for: ${name}!`, 'success', messageBoxId);
                
            } catch (e) {
                console.error("Error updating stock:", e);
                showMessage(`Error updating stock. Check console for details.`, "error", messageBoxId);
            }
        }

        async function handleStockInForm(event) {
            event.preventDefault();
            const itemName = document.getElementById('stock-in-item-name').value.trim();
            const partNumber = document.getElementById('stock-in-part-number').value.trim();
            const packageValue = document.getElementById('stock-in-package').value.trim();
            const quantity = parseInt(document.getElementById('stock-in-quantity').value.trim(), 10);
            
            if (!itemName || !partNumber || !packageValue || quantity <= 0) {
                showMessage("Please fill out all required fields correctly.", "error", 'message-box-stock-in');
                return;
            }

            await updateInventory(itemName, null, null, partNumber, packageValue, quantity, 'in', 'message-box-stock-in');
            document.getElementById('stock-in-form').reset();
            document.getElementById('stock-in-item-name').focus(); 
        }

        async function handleStockOutForm(event) {
            event.preventDefault();
            const quantity = parseInt(document.getElementById('stock-out-quantity').value.trim(), 10);
            const itemName = document.getElementById('stock-out-item-name').value.trim();
            const studentName = document.getElementById('stock-out-student-name').value.trim();
            const partNumber = document.getElementById('stock-out-part-number').value.trim();
            const srNumber = document.getElementById('stock-out-sr-number').value.trim();
            
            const packageValue = document.getElementById('stock-out-package').value.trim();

            if (itemName && partNumber && quantity > 0) {
                await updateInventory(itemName, studentName, srNumber, partNumber, packageValue, quantity, 'out', 'message-box-stock-out');
                document.getElementById('stock-out-form').reset();
                document.getElementById('stock-out-student-name').focus();
            } else {
                showMessage("Please fill out item name, part number, and quantity correctly.", "error", 'message-box-stock-out');
            }
        }
        
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && event.target.form?.id === 'stock-out-form') {
                if (event.target.id === 'stock-out-student-name') {
                    const srNumberInput = document.getElementById('stock-out-sr-number');
                    if (srNumberInput.disabled) {
                        event.preventDefault();
                        document.getElementById('stock-out-item-name').focus();
                        return;
                    }
                }
                
                const form = event.target.form;
                const formFields = Array.from(form.elements).filter(el => el.tagName === 'INPUT');
                const currentIndex = formFields.indexOf(event.target);
                
                if (currentIndex === formFields.length - 1) {
                    return;
                }
                
                event.preventDefault();
                const nextIndex = currentIndex + 1;
                if (nextIndex < formFields.length) {
                    formFields[nextIndex].focus();
                }
            }
        });
        
        // Function to export current inventory to CSV
        function exportInventoryToCsv() {
            if (Object.keys(inventoryData).length === 0) {
                showMessage("No inventory data to export.", "error");
                return;
            }

            const header = "Item Name,Part Number,Package,Stock In Count,Stock Out Count,Available Stock,Last Updated\n";
            let csv = header;

            Object.values(inventoryData).forEach(item => {
                const lastUpdated = item.lastUpdated?.toDate().toLocaleString() || 'N/A';
                const row = `"${item.name || 'N/A'}","${item.partNumber || 'N/A'}","${item.package || 'N/A'}",${item.stockIn || 0},${item.stockOut || 0},${item.totalQuantity || 0},"${lastUpdated}"\n`;
                csv += row;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const timestamp = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `inventory-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("Inventory data exported successfully!", "success");
        }

        // Function to export transaction history to CSV
        function exportTransactionsToCsv() {
            const stockOutTransactions = transactionsData.filter(t => t.type === 'out');
            if (stockOutTransactions.length === 0) {
                showMessage("No stock out transactions to export.", "error");
                return;
            }

            const header = "Student Name,SR Number,Item Name,Part Number,Package,Quantity,Timestamp,Status\n";
            let csv = header;

            stockOutTransactions.forEach(transaction => {
                const timestamp = transaction.timestamp?.toDate().toLocaleString() || 'N/A';
                const status = transaction.isReturned ? 'Returned' : 'Pending';
                const row = `"${transaction.studentName || 'N/A'}","${transaction.srNumber || 'N/A'}","${transaction.name || 'N/A'}","${transaction.partNumber || 'N/A'}","${transaction.package || 'N/A'}",${transaction.quantity},"${timestamp}","${status}"\n`;
                csv += row;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const timestamp = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `transactions-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("Transaction history exported successfully!", "success");
        }

        // Function to import data from a CSV file
        function importFromCsv(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const rows = text.split('\n');
                if (rows.length <= 1) {
                    showMessage("CSV file is empty or has no data rows.", "error");
                    return;
                }
                const header = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
                if (!db || !auth.currentUser) {
                    showMessage("Database not connected. Please refresh.", "error");
                    return;
                }
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const batch = writeBatch(db);
                const importMessageId = 'message-box-import';
                let successCount = 0;
                let errorCount = 0;

                showMessage("Starting import...", "info", importMessageId);

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].trim();
                    if (!row) continue;

                    const values = row.split(',').map(v => v.trim().replace(/"/g, ''));
                    const item = {};
                    header.forEach((key, index) => {
                        item[key] = values[index];
                    });
                    
                    const itemName = item['Item Name'] || '';
                    const partNumber = item['Part Number'] || '';
                    const packageValue = item['Package'] || '';
                    const totalQuantity = parseInt(item['Available Stock'], 10);
                    const stockIn = parseInt(item['Stock In Count'], 10) || 0;
                    const stockOut = parseInt(item['Stock Out Count'], 10) || 0;

                    if (!itemName || !partNumber || !packageValue || isNaN(totalQuantity)) {
                        console.error("Skipping invalid row:", item);
                        errorCount++;
                        continue;
                    }
                    
                    const barcode = `${itemName.replace(/\s/g, '').toLowerCase()}-${partNumber.replace(/\s/g, '').toLowerCase()}-${packageValue.replace(/\s/g, '').toLowerCase()}`;
                    const itemRef = doc(db, `artifacts/${appId}/public/data/inventory`, barcode);

                    batch.set(itemRef, {
                        barcode: barcode,
                        name: itemName,
                        partNumber: partNumber,
                        package: packageValue,
                        totalQuantity: totalQuantity,
                        stockIn: stockIn,
                        stockOut: stockOut,
                        lastUpdated: serverTimestamp()
                    });
                    successCount++;
                }

                try {
                    await batch.commit();
                    showMessage(`Import successful! ${successCount} items processed.`, "success", importMessageId);
                } catch (e) {
                    console.error("Batch write failed:", e);
                    showMessage(`Import failed. ${successCount} items processed before the error. Check console.`, "error", importMessageId);
                }
            };
            reader.readAsText(file);
        }

        // Function to delete all inventory items
        async function clearInventory() {
            if (!db || !auth.currentUser) {
                showMessage("Database not connected or user not authenticated. Please refresh.", "error");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const inventoryCollectionRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            showMessage("Clearing inventory...", "info");
            
            try {
                const querySnapshot = await getDocs(inventoryCollectionRef);
                if (querySnapshot.empty) {
                    showMessage("Inventory is already empty. Nothing to clear.", "success");
                    return;
                }

                const batch = writeBatch(db);
                querySnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                showMessage("Inventory cleared successfully!", "success");
            } catch (e) {
                console.error("Error clearing inventory:", e);
                showMessage("Failed to clear inventory. Check console for details.", "error");
            }
        }

        // Function to delete all transaction history
        async function clearTransactions() {
            if (!db || !auth.currentUser) {
                showMessage("Database not connected or user not authenticated. Please refresh.", "error");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const transactionsCollectionRef = collection(db, `artifacts/${appId}/public/data/transactions`);
            showMessage("Clearing transaction history...", "info");

            try {
                const querySnapshot = await getDocs(transactionsCollectionRef);
                if (querySnapshot.empty) {
                    showMessage("Transaction history is already empty. Nothing to clear.", "success");
                    return;
                }

                const batch = writeBatch(db);
                querySnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                showMessage("Transaction history cleared successfully!", "success");
            } catch (e) {
                console.error("Error clearing transactions:", e);
                showMessage("Failed to clear transaction history. Check console for details.", "error");
            }
        }

        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            const filteredData = Object.values(inventoryData).filter(item => 
                (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                (item.partNumber && item.partNumber.toLowerCase().includes(searchTerm)) ||
                (item.package && item.package.toLowerCase().includes(searchTerm)) ||
                (item.barcode && item.barcode.toLowerCase().includes(searchTerm))
            );
            renderInventoryTable(filteredData);
        }

        // New function to handle searching transactions
        function handleTransactionSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            const filteredData = transactionsData.filter(transaction => {
                if (transaction.type !== 'out') return false;
                const matchesStudent = transaction.studentName && transaction.studentName.toLowerCase().includes(searchTerm);
                const matchesSrNumber = transaction.srNumber && transaction.srNumber.toLowerCase().includes(searchTerm);
                const matchesItemName = transaction.name && transaction.name.toLowerCase().includes(searchTerm);
                const matchesPartNumber = transaction.partNumber && transaction.partNumber.toLowerCase().includes(searchTerm);
                const matchesPackage = transaction.package && transaction.package.toLowerCase().includes(searchTerm);
                return matchesStudent || matchesSrNumber || matchesItemName || matchesPartNumber || matchesPackage;
            });
            renderTransactionsTable(filteredData);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            // Setup event listeners
            document.getElementById('inventory-link').addEventListener('click', () => switchView('inventory-view'));
            document.getElementById('stock-in-link').addEventListener('click', () => switchView('stock-in-view'));
            document.getElementById('stock-out-link').addEventListener('click', () => switchView('stock-out-view'));
            document.getElementById('transactions-link').addEventListener('click', () => switchView('transactions-view'));
            document.getElementById('back-to-inventory').addEventListener('click', () => switchView('inventory-view'));
            document.getElementById('stock-in-form').addEventListener('submit', handleStockInForm);
            document.getElementById('stock-out-form').addEventListener('submit', handleStockOutForm);
            document.getElementById('edit-form').addEventListener('submit', handleEditForm);
            document.getElementById('export-inventory-btn').addEventListener('click', exportInventoryToCsv);
            document.getElementById('export-transactions-btn').addEventListener('click', exportTransactionsToCsv);
            document.getElementById('import-csv-input').addEventListener('change', importFromCsv);
            document.getElementById('search-input').addEventListener('input', handleSearch);
            
            // New clear buttons
            document.getElementById('clear-inventory-btn').addEventListener('click', () => {
                showConfirmationModal("Are you sure you want to clear ALL inventory data? This action cannot be undone.", clearInventory);
            });
            document.getElementById('clear-transactions-btn').addEventListener('click', () => {
                showConfirmationModal("Are you sure you want to clear ALL transaction history? This action cannot be undone.", clearTransactions);
            });

            // New search listener for transactions
            document.getElementById('transaction-search-input').addEventListener('input', handleTransactionSearch);

            // Autofill listeners
            document.getElementById('stock-out-student-name').addEventListener('input', handleStudentNameInput);
            document.getElementById('stock-out-item-name').addEventListener('input', handleItemNameInput);
        });
        
        // Expose functions to the global scope for event handlers in the HTML
        window.returnItem = returnItem;
    </script>
    <style>
        body {
            background-color: #e2e8f0;
            background-image: linear-gradient(135deg, #f0f4f8 25%, transparent 25%), linear-gradient(-135deg, #f0f4f8 25%, transparent 25%), linear-gradient(45deg, #f0f4f8 25%, transparent 25%), linear-gradient(-45deg, #f0f4f8 25%, transparent 25%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 0, 10px -10px, 0 10px;
        }
        .glow-focus:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-['Inter'] flex flex-col min-h-screen">
    <div class="container mx-auto p-4 md:p-8 flex-grow">
        <!-- Header and Navigation -->
        <header class="bg-white rounded-2xl shadow-2xl p-6 mb-8 transform hover:scale-105 transition-transform duration-300">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 mb-2 md:mb-0">DESE Inventory System</h1>
                <p id="user-id-display" class="text-sm font-medium text-gray-500 bg-gray-100 px-4 py-2 rounded-full border border-gray-200 shadow-inner"></p>
            </div>
            <nav class="flex flex-wrap gap-2 md:gap-4 font-semibold text-gray-700">
                <button id="inventory-link" data-view-id="inventory-view" class="px-6 py-3 rounded-full hover:bg-indigo-500 hover:text-white transition-colors duration-200 transform hover:-translate-y-1 shadow-lg">
                    <i class="fas fa-boxes mr-2"></i>Inventory
                </button>
                <button id="stock-in-link" data-view-id="stock-in-view" class="px-6 py-3 rounded-full hover:bg-indigo-500 hover:text-white transition-colors duration-200 transform hover:-translate-y-1 shadow-lg">
                    <i class="fas fa-arrow-alt-circle-down mr-2"></i>Stock In
                </button>
                <button id="stock-out-link" data-view-id="stock-out-view" class="px-6 py-3 rounded-full hover:bg-indigo-500 hover:text-white transition-colors duration-200 transform hover:-translate-y-1 shadow-lg">
                    <i class="fas fa-arrow-alt-circle-up mr-2"></i>Stock Out
                </button>
                <button id="transactions-link" data-view-id="transactions-view" class="px-6 py-3 rounded-full hover:bg-indigo-500 hover:text-white transition-colors duration-200 transform hover:-translate-y-1 shadow-lg">
                    <i class="fas fa-history mr-2"></i>Transactions
                </button>
            </nav>
            <div id="message-box" class="hidden"></div>
        </header>

        <!-- Inventory View -->
        <main id="inventory-view" class="app-view">
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Current Inventory</h2>
                    <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                        <input type="text" id="search-input" placeholder="Search inventory..." class="flex-grow md:flex-grow-0 px-4 py-2 rounded-full border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200 shadow-inner glow-focus">
                        <label class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-full shadow-md hover:bg-blue-600 transition-colors duration-200 cursor-pointer text-center flex items-center justify-center space-x-2">
                            <i class="fas fa-file-import"></i>
                            <span>Import CSV</span>
                            <input type="file" id="import-csv-input" accept=".csv" class="hidden">
                        </label>
                        <button id="export-inventory-btn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition-colors duration-200 flex items-center justify-center space-x-2">
                            <i class="fas fa-file-export"></i>
                            <span>Export CSV</span>
                        </button>
                        <button id="clear-inventory-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-full shadow-md hover:bg-red-600 transition-colors duration-200 flex items-center justify-center space-x-2">
                            <i class="fas fa-trash-alt"></i>
                            <span>Clear Inventory</span>
                        </button>
                    </div>
                </div>
                <div id="message-box-import" class="mb-4"></div>
                <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-inner">
                    <table class="min-w-full bg-white divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Item Name</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Part Number</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Package</th>
                                <th class="p-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Stock In</th>
                                <th class="p-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Stock Out</th>
                                <th class="p-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Total Quantity</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Last Updated</th>
                                <th class="p-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list" class="divide-y divide-gray-200">
                            <!-- Inventory items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Stock In View -->
        <main id="stock-in-view" class="app-view hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Stock In Items</h2>
                <div id="message-box-stock-in" class="mt-4"></div>
                <form id="stock-in-form" class="space-y-4">
                    <div>
                        <label for="stock-in-item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="stock-in-item-name" name="item-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 glow-focus">
                    </div>
                    <div>
                        <label for="stock-in-part-number" class="block text-sm font-medium text-gray-700">Part Number</label>
                        <input type="text" id="stock-in-part-number" name="part-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 glow-focus">
                    </div>
                    <div>
                        <label for="stock-in-package" class="block text-sm font-medium text-gray-700">Package</label>
                        <input type="text" id="stock-in-package" name="package" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 glow-focus">
                    </div>
                    <div>
                        <label for="stock-in-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="stock-in-quantity" name="quantity" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 glow-focus">
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-full shadow-md hover:bg-indigo-700 transition-colors duration-200 transform hover:-translate-y-1">
                        <i class="fas fa-plus-circle mr-2"></i>Add to Stock
                    </button>
                </form>
            </div>
        </main>

        <!-- Stock Out View -->
        <main id="stock-out-view" class="app-view hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Stock Out Items</h2>
                <div id="message-box-stock-out" class="mt-4"></div>
                <form id="stock-out-form" class="space-y-4">
                    <div>
                        <label for="stock-out-student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                        <input type="text" id="stock-out-student-name" name="student-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 glow-focus">
                    </div>
                    <div>
                        <label for="stock-out-sr-number" class="block text-sm font-medium text-gray-700">SR Number</label>
                        <input type="text" id="stock-out-sr-number" name="sr-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 bg-gray-100 cursor-not-allowed">
                        <p id="student-autofill-message" class="mt-2 text-sm text-gray-500"></p>
                    </div>
                    <div>
                        <label for="stock-out-item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="stock-out-item-name" name="item-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 glow-focus">
                        <div id="item-suggestions" class="bg-white border border-gray-300 rounded-lg mt-2 shadow-lg max-h-48 overflow-y-auto hidden"></div>
                        <p id="autofill-message-stock-out" class="mt-2 text-sm text-gray-500"></p>
                    </div>
                    <div>
                        <label for="stock-out-part-number" class="block text-sm font-medium text-gray-700">Part Number</label>
                        <input type="text" id="stock-out-part-number" name="part-number" required readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 bg-gray-100 cursor-not-allowed">
                    </div>
                    <div>
                        <label for="stock-out-package" class="block text-sm font-medium text-gray-700">Package</label>
                        <input type="text" id="stock-out-package" name="package" required readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 bg-gray-100 cursor-not-allowed">
                    </div>
                    <div>
                        <label for="stock-out-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="stock-out-quantity" name="quantity" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 glow-focus">
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-full shadow-md hover:bg-indigo-700 transition-colors duration-200 transform hover:-translate-y-1">
                        <i class="fas fa-minus-circle mr-2"></i>Stock Out
                    </button>
                </form>
            </div>
        </main>
        
        <!-- Transactions View -->
        <main id="transactions-view" class="app-view hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-900">Transaction History</h2>
                    <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                        <input type="text" id="transaction-search-input" placeholder="Search transactions..." class="flex-grow md:flex-grow-0 px-4 py-2 rounded-full border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200 shadow-inner glow-focus">
                        <button id="export-transactions-btn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition-colors duration-200 flex items-center justify-center space-x-2">
                            <i class="fas fa-file-export"></i>
                            <span>Export CSV</span>
                        </button>
                        <button id="clear-transactions-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-full shadow-md hover:bg-red-600 transition-colors duration-200 flex items-center justify-center space-x-2">
                            <i class="fas fa-trash-alt"></i>
                            <span>Clear Transactions</span>
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-inner">
                    <table class="min-w-full bg-white divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Student Name</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">SR Number</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Item Name</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Part Number</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Package</th>
                                <th class="p-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="p-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="p-4 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-list" class="divide-y divide-gray-200">
                            <!-- Transactions will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Edit View -->
        <main id="edit-view" class="app-view hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-900">Edit Item</h2>
                    <button id="back-to-inventory" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full shadow-md hover:bg-gray-300 transition-colors duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>Go Back
                    </button>
                </div>
                <div id="message-box-edit" class="mt-4"></div>
                <form id="edit-form" class="space-y-4">
                    <div>
                        <label for="edit-item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="edit-item-name" name="item-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500 glow-focus">
                    </div>
                    <div>
                        <label for="edit-part-number" class="block text-sm font-medium text-gray-700">Part Number</label>
                        <input type="text" id="edit-part-number" name="part-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500 glow-focus">
                    </div>
                    <div>
                        <label for="edit-package" class="block text-sm font-medium text-gray-700">Package</label>
                        <input type="text" id="edit-package" name="package" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500 glow-focus">
                    </div>
                    <div>
                        <label for="edit-quantity" class="block text-sm font-medium text-gray-700">Total Quantity</label>
                        <input type="number" id="edit-quantity" name="quantity" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500 glow-focus">
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-yellow-500 text-white font-semibold rounded-full shadow-md hover:bg-yellow-600 transition-colors duration-200 transform hover:-translate-y-1">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </form>
            </div>
        </main>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-sm mx-auto">
                <p id="confirmation-message" class="text-center font-semibold mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-yes" class="px-6 py-2 bg-red-500 text-white font-bold rounded-full hover:bg-red-600 transition-colors duration-200">Yes</button>
                    <button id="confirm-no" class="px-6 py-2 bg-gray-300 text-gray-800 font-bold rounded-full hover:bg-gray-400 transition-colors duration-200">No</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
