<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESE Electronics Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- PDF Generation Library (html2pdf.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            setDoc, 
            updateDoc, 
            increment, 
            serverTimestamp,
            query,
            limit,
            orderBy,
            writeBatch,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (Mandated) ---
        // Accessing Canvas environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initializing Firebase App, Auth, and Firestore instances
        let app, db, auth;
        let currentUserId = 'anonymous'; // Will be updated on successful auth
        let isAuthReady = false; // Flag to ensure data operations wait for auth

        // --- Application State ---
        let inventory = [];
        let transactions = [];
        let activeItemId = null;
        let activeTransactionType = null;
        let activeFineTransaction = null; // NEW: Holds the transaction being fined
        let currentPage = 'inventory'; // 'inventory' or 'transactions'

        // --- Utility Functions ---

        /**
         * @returns {string} The Firestore path for the current user's data.
         * Structure: /artifacts/{appId}/users/{userId}/{collectionName}
         */
        const firestorePath = (collectionName) => {
            // Private user data path: /artifacts/{appId}/users/{userId}/{collectionName}
            return `artifacts/${appId}/users/${currentUserId}/${collectionName}`;
        };

        /**
         * Converts Firestore timestamp object to a readable date string.
         * @param {object} timestamp - Firestore Timestamp object.
         * @returns {string} Formatted date string.
         */
        const formatTimestamp = (timestamp) => {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            }
            return 'N/A';
        };

        /**
         * Displays a temporary message (success/error/info) to the user.
         * @param {string} message - The message text.
         * @param {('success'|'error'|'info')} type - The type of message.
         */
        const showMessage = (message, type = 'info') => {
            const messageBox = document.getElementById('message-box');
            let bgColor = 'bg-blue-500';
            let icon = 'ℹ️';

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = '✅';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = '❌';
                    break;
            }

            messageBox.innerHTML = `<div class="p-3 ${bgColor} text-white rounded-lg shadow-xl flex items-center space-x-2"><span>${icon}</span><span>${message}</span></div>`;
            messageBox.classList.remove('hidden');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
                messageBox.innerHTML = '';
            }, 5000);
        };

        // --- Data Fetching and Real-time Listeners (Firestore) ---

        /**
         * Loads the inventory collection in real-time.
         */
        window.loadInventory = () => {
            if (!isAuthReady || !db) return;
            console.log("Loading inventory data...");

            const q = collection(db, firestorePath('inventory'));
            
            // onSnapshot provides real-time updates
            onSnapshot(q, (snapshot) => {
                inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInventory();
                console.log(`Inventory updated: ${inventory.length} items.`);
            }, (error) => {
                console.error("Error fetching inventory: ", error);
                showMessage(`Failed to load inventory data: ${error.message}`, 'error');
            });
        };

        /**
         * Loads the transaction collection in real-time (most recent 50).
         */
        window.loadTransactions = () => {
            if (!isAuthReady || !db) return;
            console.log("Loading transactions data...");

            const q = query(
                collection(db, firestorePath('transactions')),
                orderBy('timestamp', 'desc'),
                limit(50) // Limit to 50 most recent transactions
            );

            onSnapshot(q, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTransactions();
                console.log(`Transactions updated: ${transactions.length} records.`);
            }, (error) => {
                console.error("Error fetching transactions: ", error);
                showMessage(`Failed to load transaction data: ${error.message}`, 'error');
            });
        };

        // --- Core Application Logic ---

        /**
         * Initializes Firebase and authenticates the user.
         */
        window.setupFirebaseAndAuth = async () => {
            try {
                setLogLevel('debug');
                
                // Use the Firebase config provided by the Canvas environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

                const firebaseConfig = firebaseConfigFromCanvas || {
                    apiKey: "AIzaSyCKLZ3BWAl0Z48H0dnprdtn2cTQ7jKlTOg",
                    authDomain: "deseinventory.firebaseapp.com",
                    projectId: "deseinventory",
                    storageBucket: "deseinventory.firebasestorage.app",
                    messagingSenderId: "765936216501",
                    appId: "1:765936216501:web:972c9f9355ca638d81d1fc",
                    measurementId: "G-M2STNJYRP9"
                };
                // Initialize Firebase services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // Set Firestore log level for debugging
                // setLogLevel('Debug'); // Uncomment for detailed console logs

                // 1. Attempt custom token sign-in (provided by canvas) or anonymous sign-in
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth State Listener (Crucial for getting userId)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        
                        // Display User ID on UI
                        document.getElementById('user-id-display').textContent = `User ID: ${currentUserId}`;
                        
                        // Load data once authenticated
                        window.loadInventory();
                        window.loadTransactions();
                        
                    } else {
                        currentUserId = 'anonymous';
                        isAuthReady = false;
                        document.getElementById('user-id-display').textContent = `User ID: Not Signed In`;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Authentication Error:", error);
                showMessage(`Auth failed: ${error.message}. App will run in limited mode.`, 'error');
            }
        };

        /**
         * Shows the modal for adding a new inventory item.
         */
        window.openAddItemModal = () => {
            document.getElementById('item-form').reset();
            document.getElementById('item-form-title').textContent = 'Add New Inventory Item';
            document.getElementById('item-form-submit-button').textContent = 'Add Item';
            document.getElementById('item-modal').classList.remove('hidden');
        };

        /**
         * Closes the generic modal.
         * @param {string} modalId - The ID of the modal to close.
         */
        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.add('hidden');
        };

        /**
         * Handles submission of the Add/Edit Item form.
         * @param {Event} event - The form submission event.
         */
        window.handleItemSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const itemId = form.elements['item-id'].value;
            
            const itemData = {
                name: form.elements['item-name'].value,
                partNumber: form.elements['part-number'].value,
                stock: parseInt(form.elements['stock'].value, 10),
                unit: form.elements['unit'].value,
                category: form.elements['category'].value,
                location: form.elements['location'].value,
            };

            try {
                if (itemId) {
                    // Edit existing item
                    await updateDoc(doc(db, firestorePath('inventory'), itemId), itemData);
                    showMessage('Item updated successfully!', 'success');
                } else {
                    // Add new item
                    const newDocRef = doc(collection(db, firestorePath('inventory')));
                    await setDoc(newDocRef, { ...itemData, createdAt: serverTimestamp() });
                    showMessage('New item added successfully!', 'success');
                }
                closeModal('item-modal');
            } catch (error) {
                console.error("Error saving item:", error);
                showMessage(`Failed to save item: ${error.message}`, 'error');
            }
        };

        /**
         * Shows the modal for editing an existing inventory item.
         * @param {string} itemId - The ID of the item to edit.
         */
        window.openEditItemModal = (itemId) => {
            const item = inventory.find(i => i.id === itemId);
            if (!item) {
                showMessage('Item not found.', 'error');
                return;
            }

            const form = document.getElementById('item-form');
            form.elements['item-id'].value = item.id;
            form.elements['item-name'].value = item.name;
            form.elements['part-number'].value = item.partNumber;
            form.elements['stock'].value = item.stock;
            form.elements['unit'].value = item.unit;
            form.elements['category'].value = item.category;
            form.elements['location'].value = item.location;

            document.getElementById('item-form-title').textContent = 'Edit Inventory Item';
            document.getElementById('item-form-submit-button').textContent = 'Save Changes';
            document.getElementById('item-modal').classList.remove('hidden');
        };
        
        /**
         * Opens the modal for 'Issue', 'Return', or 'Manual Receive' transactions.
         * @param {string} itemId - The ID of the item for the transaction.
         * @param {('issue'|'receive'|'return')} type - The type of transaction.
         */
        window.openTransactionModal = (itemId, type) => {
            const item = inventory.find(i => i.id === itemId);
            if (!item) {
                showMessage('Item not found.', 'error');
                return;
            }

            activeItemId = itemId;
            activeTransactionType = type;
            
            // Set modal content
            let title, subtitle;
            if (type === 'issue') {
                title = 'Issue Item to Student/Project';
                subtitle = `Issuing: ${item.name} (P/N: ${item.partNumber})`;
            } else if (type === 'receive') {
                title = 'Manual Stock Receive (Replenishment)';
                subtitle = `Receiving: ${item.name} (P/N: ${item.partNumber})`;
            } else if (type === 'return') { // NEW 'return' type
                title = 'Student Return Item';
                subtitle = `Returning: ${item.name} (P/N: ${item.partNumber})`;
            }

            const currentStockNote = `Current Stock: ${item.stock} ${item.unit}`;
            
            document.getElementById('transaction-modal-title').textContent = title;
            document.getElementById('transaction-modal-subtitle').textContent = subtitle;
            document.getElementById('transaction-current-stock-note').textContent = currentStockNote;
            
            const transactionQuantityInput = document.getElementById('transaction-quantity');
            transactionQuantityInput.value = '';
            
            // Reset the 'max' attribute (retained from previous request)
            transactionQuantityInput.removeAttribute('max');

            let dynamicInputHTML = '';
            let submitText = 'Confirm Transaction';

            if (type === 'issue') {
                dynamicInputHTML = `
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name / SR No.</label>
                        <input type="text" id="student-name" name="student-name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Jane Doe / 12345">
                    </div>
                `;
                 submitText = 'Confirm Issue';
            } else if (type === 'return') { // NEW 'return' input
                dynamicInputHTML = `
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name / SR No.</label>
                        <input type="text" id="student-name" name="student-name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Jane Doe / 12345">
                    </div>
                    <div>
                        <label for="return-condition" class="block text-sm font-medium text-gray-700">Condition on Return / Remarks</label>
                        <input type="text" id="return-condition" name="return-condition" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Good condition, Damaged, Late return">
                    </div>
                `;
                submitText = 'Confirm Return';
            } else if (type === 'receive') {
                dynamicInputHTML = `
                    <div>
                        <label for="received-by" class="block text-sm font-medium text-gray-700">Received By / Remarks</label>
                        <input type="text" id="received-by" name="received-by" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Stock replenishment from supplier">
                    </div>
                `;
                submitText = 'Confirm Receive';
            }
            
            document.getElementById('dynamic-transaction-input').innerHTML = dynamicInputHTML;
            document.getElementById('transaction-submit-button').textContent = submitText;
            document.getElementById('transaction-modal').classList.remove('hidden');
        };

        /**
         * Handles the transaction submission (Issue, Return, or Receive).
         * @param {Event} event - The form submission event.
         */
        window.handleTransaction = async (event) => {
            event.preventDefault();

            if (!activeItemId || !activeTransactionType) {
                showMessage('Transaction error: Missing item or type.', 'error');
                return;
            }

            const transactionForm = event.target;
            const itemId = activeItemId;
            const transactionType = activeTransactionType;
            const quantity = parseInt(transactionForm.elements['transaction-quantity'].value, 10);
            
            if (quantity <= 0) {
                showMessage('Quantity must be a positive number.', 'error');
                return;
            }

            const item = inventory.find(i => i.id === itemId);
            if (!item) {
                showMessage('Item not found.', 'error');
                return;
            }

            let change = 0;
            let recordDetails = {};
            let successMessage = '';

            if (transactionType === 'issue') {
                change = -quantity;
                recordDetails.studentName = transactionForm.elements['student-name'].value;
                recordDetails.transactionActor = recordDetails.studentName;
                successMessage = `${item.name}: ${quantity} issued successfully.`;
            } else if (transactionType === 'return') { // NEW 'return' logic
                change = quantity;
                recordDetails.studentName = transactionForm.elements['student-name'].value;
                recordDetails.returnCondition = transactionForm.elements['return-condition'].value;
                recordDetails.transactionActor = recordDetails.studentName;
                successMessage = `${item.name}: ${quantity} returned successfully.`;
            } else if (transactionType === 'receive') {
                change = quantity;
                recordDetails.receivedBy = transactionForm.elements['received-by'].value;
                recordDetails.transactionActor = recordDetails.receivedBy;
                successMessage = `${item.name}: ${quantity} received successfully (manual replenishment).`;
            }

            try {
                // 1. Update the inventory item's stock
                const itemDocRef = doc(db, firestorePath('inventory'), itemId);
                await updateDoc(itemDocRef, {
                    stock: increment(change)
                });

                // 2. Add a new transaction record
                const transactionData = {
                    itemId: itemId,
                    itemName: item.name,
                    partNumber: item.partNumber,
                    type: transactionType,
                    quantity: quantity,
                    stockBefore: item.stock,
                    stockAfter: item.stock + change,
                    timestamp: serverTimestamp(),
                    userId: currentUserId,
                    ...recordDetails
                };

                const newTransactionRef = doc(collection(db, firestorePath('transactions')));
                await setDoc(newTransactionRef, transactionData);

                showMessage(successMessage, 'success');
                closeModal('transaction-modal');
                
            } catch (error) {
                console.error("Error handling transaction:", error);
                showMessage(`Transaction failed: ${error.message}`, 'error');
            }
        };

        // --- Fine Challan Logic (NEW) ---

        /**
         * Opens the modal for generating a Fine Challan PDF for a specific transaction.
         * @param {string} transactionId - The ID of the transaction to fine.
         */
        window.openFineChallanModal = (transactionId) => {
            const tx = transactions.find(t => t.id === transactionId);
            if (!tx) {
                showMessage('Transaction record not found.', 'error');
                return;
            }
            // Must be an issue or return transaction to have a responsible party
            if (tx.type === 'receive') {
                 showMessage('Fine Challans are only for Issue or Return transactions.', 'error');
                 return;
            }

            activeFineTransaction = tx;
            
            document.getElementById('fine-challan-modal-title').textContent = `Fine Challan for: ${tx.itemName}`;
            document.getElementById('fine-challan-item-info').innerHTML = `
                <span class="font-semibold">Transaction ID:</span> ${tx.id.slice(0, 8)}...<br>
                <span class="font-semibold">Item:</span> ${tx.itemName} (P/N: ${tx.partNumber})<br>
                <span class="font-semibold">Issued/Returned By:</span> ${tx.transactionActor || 'N/A'}<br>
            `;
            
            // Pre-fill student name/sr no if available
            document.getElementById('fine-challan-student-name').value = tx.studentName || tx.transactionActor || '';
            
            document.getElementById('fine-challan-form').reset();
            document.getElementById('fine-challan-modal').classList.remove('hidden');
        };

        /**
         * Handles the submission of the fine challan form and triggers PDF generation.
         * @param {Event} event - The form submission event.
         */
        window.handleFineChallanSubmit = (event) => {
            event.preventDefault();
            const form = event.target;
            
            if (!activeFineTransaction) {
                showMessage('Error: No active transaction for fine.', 'error');
                return;
            }

            const fineData = {
                transaction: activeFineTransaction,
                studentName: form.elements['fine-challan-student-name'].value,
                reason: form.elements['fine-challan-reason'].value,
                amount: form.elements['fine-challan-amount'].value,
                issueDate: new Date().toLocaleDateString(),
                issuedBy: currentUserId,
            };
            
            generateFineChallanPDF(fineData);
            closeModal('fine-challan-modal');
        };

        /**
         * Generates the Fine Challan PDF document using html2pdf.
         * @param {object} fineData - Data gathered from the fine form and the transaction record.
         */
        window.generateFineChallanPDF = (fineData) => {
            // HTML content with inline styles for PDF generation reliability
            const challanContent = `
                <div style="padding: 20px; font-family: 'Inter', sans-serif; max-width: 800px; margin: auto; border: 2px solid #fbbf24; border-radius: 8px;">
                    <div style="text-align: center; border-bottom: 2px solid #fbbf24; padding-bottom: 10px; margin-bottom: 20px;">
                        <h1 style="font-size: 24px; font-weight: bold; color: #b45309;">DESE Electronics Lab</h1>
                        <h2 style="font-size: 20px; font-weight: bold; color: #4b5563;">Official Fine Challan</h2>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <p style="font-size: 14px;"><strong>Challan ID:</strong> ${fineData.transaction.id.slice(0, 8)}-FINE</p>
                        <p style="font-size: 14px;"><strong>Date Issued:</strong> ${fineData.issueDate}</p>
                    </div>

                    <div style="border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; font-weight: bold; color: #1f2937; margin-bottom: 10px;">Student / User Details</h3>
                        <p style="font-size: 14px;"><strong>Name/SR No:</strong> ${fineData.studentName}</p>
                        <p style="font-size: 14px;"><strong>Associated Transaction Type:</strong> ${fineData.transaction.type.toUpperCase()}</p>
                    </div>
                    
                    <div style="border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; font-weight: bold; color: #1f2937; margin-bottom: 10px;">Fine Details</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr>
                                <td style="padding: 8px 0; border-bottom: 1px dashed #e5e7eb;"><strong>Item Fined:</strong></td>
                                <td style="padding: 8px 0; border-bottom: 1px dashed #e5e7eb; text-align: right;">${fineData.transaction.itemName} (P/N: ${fineData.transaction.partNumber})</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; border-bottom: 1px dashed #e5e7eb;"><strong>Quantity Involved:</strong></td>
                                <td style="padding: 8px 0; border-bottom: 1px dashed #e5e7eb; text-align: right;">${fineData.transaction.quantity}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; border-bottom: 1px dashed #e5e7eb;"><strong>Reason for Fine:</strong></td>
                                <td style="padding: 8px 0; border-bottom: 1px dashed #e5e7eb; text-align: right;">${fineData.reason}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px 0; font-size: 16px; font-weight: bold;">TOTAL FINE AMOUNT:</td>
                                <td style="padding: 10px 0; font-size: 16px; font-weight: bold; color: #dc2626; text-align: right;">₹ ${fineData.amount}</td>
                            </tr>
                        </table>
                    </div>

                    <p style="font-size: 12px; color: #6b7280; text-align: center; margin-top: 30px;">
                        Please settle this challan at the accounts office within 7 working days.
                    </p>
                    <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                        <div style="text-align: center; width: 45%;">
                            <p style="border-top: 1px solid #4b5563; padding-top: 5px; font-size: 14px;">Signature of Student / User</p>
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <p style="border-top: 1px solid #4b5563; padding-top: 5px; font-size: 14px;">Issued By (User ID: ${fineData.issuedBy.slice(0, 8)}...)</p>
                        </div>
                    </div>
                </div>
            `;

            html2pdf().from(challanContent).set({
                margin: 0.5,
                filename: `Fine_Challan_${fineData.studentName.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            }).save();
            
            showMessage('Fine Challan PDF generated.', 'success');
        };
        
        // --- View Switching and Data Management ---

        /**
         * Toggles the main view between Inventory and Transactions.
         * @param {string} view - 'inventory' or 'transactions'.
         */
        window.switchView = (view) => {
            currentPage = view;
            
            document.getElementById('inventory-view').classList.toggle('hidden', view !== 'inventory');
            document.getElementById('transactions-view').classList.toggle('hidden', view !== 'transactions');
            
            // Update button styles
            document.querySelectorAll('[data-view-toggle]').forEach(btn => {
                btn.classList.remove('bg-yellow-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`[data-view-toggle="${view}"]`).classList.add('bg-yellow-600', 'text-white');
            document.querySelector(`[data-view-toggle="${view}"]`).classList.remove('bg-gray-200', 'text-gray-700');
        };

        // --- PDF Reporting Logic ---

        /**
         * Generates a PDF report for the inventory.
         */
        window.generateInventoryReport = () => {
            const table = document.getElementById('inventory-table');
            const clone = table.cloneNode(true);

            // Clean up clone: remove action buttons
            clone.querySelectorAll('.action-cell').forEach(cell => cell.remove());
            clone.querySelectorAll('th:last-child').forEach(th => th.remove());
            
            // Create a temporary container for styling
            const container = document.createElement('div');
            container.classList.add('p-8');
            container.innerHTML = `
                <h1 class="text-2xl font-bold mb-2">DESE Electronics Inventory Report</h1>
                <p class="text-sm mb-4">Generated by User ID: ${currentUserId} on ${new Date().toLocaleString()}</p>
            `;
            container.appendChild(clone);

            // Configure html2pdf
            html2pdf().from(container).set({
                margin: 0.5,
                filename: `inventory_report_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            }).save();

            showMessage('Inventory Report PDF generated.', 'success');
        };

        // --- Rendering Functions ---

        /**
         * Renders the inventory table based on the current state.
         */
        const renderInventory = () => {
            const tableBody = document.getElementById('inventory-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            if (inventory.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">No inventory items found. Add your first item!</td></tr>`;
                return;
            }

            inventory.forEach(item => {
                const stockColor = item.stock <= 5 && item.stock > 0 ? 'text-orange-500 font-semibold' : item.stock <= 0 ? 'text-red-500 font-bold' : 'text-gray-900';
                
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'border-b');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.partNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${stockColor}">${item.stock} ${item.unit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.location}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTimestamp(item.createdAt)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium action-cell">
                        <button onclick="openTransactionModal('${item.id}', 'issue')" class="text-red-600 hover:text-red-900 mr-3 font-medium transition duration-150">Issue</button>
                        <button onclick="openTransactionModal('${item.id}', 'return')" class="text-blue-600 hover:text-blue-900 mr-3 font-medium transition duration-150">Return</button>
                        <button onclick="openTransactionModal('${item.id}', 'receive')" class="text-green-600 hover:text-green-900 mr-3 font-medium transition duration-150">Receive</button>
                        <button onclick="openEditItemModal('${item.id}')" class="text-yellow-600 hover:text-yellow-900 transition duration-150">Edit</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        /**
         * Renders the transactions table based on the current state.
         */
        const renderTransactions = () => {
            const tableBody = document.getElementById('transactions-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            if (transactions.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">No transactions recorded yet.</td></tr>`;
                return;
            }

            transactions.forEach(tx => {
                let typeColor, sign;
                if (tx.type === 'issue') {
                    typeColor = 'bg-red-100 text-red-800';
                    sign = '-';
                } else if (tx.type === 'return') {
                    typeColor = 'bg-blue-100 text-blue-800';
                    sign = '+';
                } else { // receive
                    typeColor = 'bg-green-100 text-green-800';
                    sign = '+';
                }
                
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'border-b');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.itemName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.partNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeColor}">
                            ${tx.type.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${tx.type === 'issue' ? 'text-red-600' : 'text-green-600'}">${sign}${tx.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.stockBefore} → ${tx.stockAfter}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tx.transactionActor || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTimestamp(tx.timestamp)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium action-cell">
                        ${tx.type !== 'receive' ? // Only allow fine for issue or return transactions
                            `<button onclick="openFineChallanModal('${tx.id}')" class="text-purple-600 hover:text-purple-900 transition duration-150">Challan</button>` : '—'}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };
        
        /**
         * Clears all inventory and transaction data.
         */
        window.clearAllData = async () => {
             // 1. Show confirmation modal
             const confirmationModal = document.getElementById('confirmation-modal');
             document.getElementById('confirmation-title').textContent = 'Confirm Data Deletion';
             document.getElementById('confirmation-message').textContent = 'Are you absolutely sure you want to delete ALL inventory items and ALL transaction history? This action cannot be undone.';
             document.getElementById('confirmation-confirm-button').onclick = executeClearAllData;
             confirmationModal.classList.remove('hidden');
        };
        
        const executeClearAllData = async () => {
            closeModal('confirmation-modal');
            showMessage('Starting data deletion...', 'info');

            const deleteCollection = async (collectionName) => {
                const collectionRef = collection(db, firestorePath(collectionName));
                const q = query(collectionRef);
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    console.log(`No documents found in ${collectionName}.`);
                    return 0;
                }

                const batch = writeBatch(db);
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                return snapshot.size;
            };

            try {
                const countInv = await deleteCollection('inventory');
                const countTx = await deleteCollection('transactions');
                
                showMessage(`Successfully deleted ${countInv} inventory items and ${countTx} transaction records.`, 'success');
            } catch (error) {
                console.error("Error clearing data:", error);
                showMessage(`Failed to clear data: ${error.message}`, 'error');
            }
        };


        // --- Startup ---
        window.onload = () => {
            window.setupFirebaseAndAuth();
            window.switchView('inventory'); // Start on the inventory page
        };
    </script>
    <style>
        /* Custom styles for a modern, clean look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .shadow-lg-yellow {
            box-shadow: 0 10px 15px -3px rgba(251, 191, 36, 0.3), 0 4px 6px -2px rgba(251, 191, 36, 0.05);
        }
        /* Style the table header */
        #inventory-table th, #transactions-table th {
            background-color: #fffbef; /* Light yellow background */
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 right-4 z-50 hidden transition-opacity duration-300">
        <!-- Messages will be injected here -->
    </div>

    <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-6 container-card">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">DESE Inventory</h1>
                <p class="text-sm text-gray-500 mt-1" id="user-id-display">User ID: Loading...</p>
            </div>
            <div class="mt-4 sm:mt-0 flex space-x-3">
                <button onclick="clearAllData()" class="px-4 py-2 text-sm font-medium rounded-full text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-md">
                    Clear All Data
                </button>
                <button onclick="openAddItemModal()" class="px-4 py-2 text-sm font-medium rounded-full text-white bg-yellow-500 hover:bg-yellow-600 transition duration-150 shadow-md shadow-lg-yellow">
                    + Add Item
                </button>
            </div>
        </header>

        <!-- View Toggler & Reporting -->
        <div class="flex flex-col sm:flex-row justify-between items-center p-4 container-card">
            <!-- View Toggles -->
            <div class="flex space-x-2 p-1 rounded-full bg-gray-100">
                <button data-view-toggle="inventory" onclick="switchView('inventory')" class="px-4 py-2 rounded-full text-sm font-medium transition duration-150 bg-yellow-600 text-white">
                    Inventory (Items)
                </button>
                <button data-view-toggle="transactions" onclick="switchView('transactions')" class="px-4 py-2 rounded-full text-sm font-medium transition duration-150 bg-gray-200 text-gray-700">
                    Transactions (History)
                </button>
            </div>
            
            <!-- Report Button -->
            <div class="mt-4 sm:mt-0">
                <button onclick="generateInventoryReport()" class="flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-full text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 transition duration-150">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2v2h-2v-2zm0-4h2v2h-2v-2zm0-4h2v2h-2V9zm-4 8h2v2h-2v-2zm0-4h2v2h-2v-2zm0-4h2v2h-2V9zm-4 8h2v2h-2v-2zm0-4h2v2h-2v-2zm0-4h2v2h-2V9z"></path></svg>
                    <span>Generate Inventory PDF Report</span>
                </button>
            </div>
        </div>

        <!-- Inventory View -->
        <section id="inventory-view" class="container-card p-6 overflow-x-auto">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Inventory Stock</h2>
            <div class="align-middle inline-block min-w-full">
                <table id="inventory-table" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">
                                Item Name
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Part Number
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Stock (Unit)
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Category
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Location
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Created At
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Inventory rows will be injected here by renderInventory() -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Transactions View -->
        <section id="transactions-view" class="container-card p-6 overflow-x-auto hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History (Last 50 Records)</h2>
            <div class="align-middle inline-block min-w-full">
                <table id="transactions-table" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">
                                Item Name
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                P/N
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Type
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Quantity
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Stock Change
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actor / Remarks
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Timestamp
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Transaction rows will be injected here by renderTransactions() -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Modals -->

    <!-- 1. Add/Edit Item Modal -->
    <div id="item-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-2xl rounded-xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="item-form-title">Add New Inventory Item</h3>
                <div class="mt-4">
                    <form id="item-form" onsubmit="handleItemSubmit(event)" class="space-y-4 text-left">
                        <input type="hidden" name="item-id">
                        
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                            <input type="text" id="item-name" name="item-name" required 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                        </div>
                        
                        <div>
                            <label for="part-number" class="block text-sm font-medium text-gray-700">Part Number / Model</label>
                            <input type="text" id="part-number" name="part-number" required 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="stock" class="block text-sm font-medium text-gray-700">Current Stock</label>
                                <input type="number" id="stock" name="stock" required min="0" 
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                            </div>
                            <div>
                                <label for="unit" class="block text-sm font-medium text-gray-700">Unit of Measure</label>
                                <input type="text" id="unit" name="unit" required 
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., pcs, meters, kits">
                            </div>
                        </div>

                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                            <input type="text" id="category" name="category" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Resistors, LEDs, Tools">
                        </div>
                        
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700">Storage Location</label>
                            <input type="text" id="location" name="location" 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Shelf A, Cabinet 3">
                        </div>
                        
                        <div class="items-center px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 space-y-3 sm:space-y-0 sm:space-x-3 sm:space-x-reverse">
                            <button type="submit" id="item-form-submit-button" class="w-full sm:w-auto py-3 px-4 bg-yellow-500 text-white font-semibold rounded-full shadow-md hover:bg-yellow-600 transition duration-150">
                                Add Item
                            </button>
                            <button type="button" onclick="closeModal('item-modal')" class="w-full sm:w-auto py-3 px-4 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-150">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Transaction Modal (Issue / Return / Receive) -->
    <div id="transaction-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-2xl rounded-xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="transaction-modal-title">Transaction</h3>
                <p class="text-sm text-gray-500 mt-2" id="transaction-modal-subtitle"></p>
                <p class="text-md font-semibold text-gray-700 mt-4 mb-4" id="transaction-current-stock-note"></p>

                <form id="transaction-form" onsubmit="handleTransaction(event)" class="space-y-4">
                    <input type="hidden" name="transaction-item-id">
                    <input type="hidden" name="transaction-type">

                    <div id="dynamic-transaction-input" class="space-y-4">
                        <!-- Student Name/SR No or Received By field will be injected here -->
                    </div>

                    <div>
                        <label for="transaction-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="transaction-quantity" name="transaction-quantity" required min="1" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                        <p class="text-xs text-gray-500 mt-1">Note: Issuing items can result in negative stock. Please verify amounts before confirming.</p>
                    </div>

                    <div class="items-center px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 space-y-3 sm:space-y-0 sm:space-x-3 sm:space-x-reverse">
                        <button type="submit" id="transaction-submit-button" class="w-full sm:w-auto py-3 px-4 bg-yellow-500 text-white font-semibold rounded-full shadow-md hover:bg-yellow-600 transition duration-150">
                            Confirm Transaction
                        </button>
                        <button type="button" onclick="closeModal('transaction-modal')" class="w-full sm:w-auto py-3 px-4 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-150">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 3. Fine Challan Modal (NEW) -->
    <div id="fine-challan-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-2xl rounded-xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="fine-challan-modal-title">Generate Fine Challan</h3>
                <p class="text-sm text-gray-500 mt-2 text-left" id="fine-challan-item-info"></p>

                <form id="fine-challan-form" onsubmit="handleFineChallanSubmit(event)" class="space-y-4 text-left">
                    
                    <div>
                        <label for="fine-challan-student-name" class="block text-sm font-medium text-gray-700">Student Name / SR No.</label>
                        <input type="text" id="fine-challan-student-name" name="fine-challan-student-name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Jane Doe / 12345">
                    </div>

                    <div>
                        <label for="fine-challan-reason" class="block text-sm font-medium text-gray-700">Reason for Fine</label>
                        <textarea id="fine-challan-reason" name="fine-challan-reason" rows="2" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Damaged component beyond repair, Late return by 3 days"></textarea>
                    </div>

                    <div>
                        <label for="fine-challan-amount" class="block text-sm font-medium text-gray-700">Fine Amount (₹)</label>
                        <input type="number" id="fine-challan-amount" name="fine-challan-amount" required min="1" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., 500">
                    </div>

                    <div class="items-center px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 space-y-3 sm:space-y-0 sm:space-x-3 sm:space-x-reverse">
                        <button type="submit" class="w-full sm:w-auto py-3 px-4 bg-purple-600 text-white font-semibold rounded-full shadow-md hover:bg-purple-700 transition duration-150">
                            Generate PDF Challan
                        </button>
                        <button type="button" onclick="closeModal('fine-challan-modal')" class="w-full sm:w-auto py-3 px-4 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-150">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 4. Confirmation Modal (Clear All Data) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-2xl rounded-xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirmation-title">Confirm Action</h3>
                <p class="text-sm text-gray-500 mt-2" id="confirmation-message"></p>

                <div class="items-center px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 space-y-3 sm:space-y-0 sm:space-x-3 sm:space-x-reverse mt-4">
                    <button type="button" id="confirmation-confirm-button" class="w-full sm:w-auto py-3 px-4 bg-red-500 text-white font-semibold rounded-full shadow-md hover:bg-red-600 transition duration-150">
                        Confirm
                    </button>
                    <button type="button" onclick="closeModal('confirmation-modal')" class="w-full sm:w-auto py-3 px-4 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-150">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
</body>
</html>
