<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESE Electronics Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, increment, serverTimestamp, setLogLevel, getDoc, getDocs, deleteDoc, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables
        let app, auth, db, userId;
        let inventoryData = {};
        let transactionsData = [];
        let studentSrMap = {};
        let currentItemToEdit = null;
        const FIREBASE_PATH = "public/data";

        // Custom message box for UI feedback
        function showMessage(message, type = 'info', messageBoxId = 'message-box') {
            const messageBox = document.getElementById(messageBoxId);
            if (!messageBox) return;

            messageBox.textContent = message;
            messageBox.className = `p-4 mt-4 rounded-lg text-center font-semibold transition-all duration-300 transform ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'} scale-100 opacity-100`;
            setTimeout(() => {
                messageBox.className = `p-4 mt-4 rounded-lg text-center font-semibold transition-all duration-300 transform ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'} scale-95 opacity-0`;
            }, 3000);
        }

        async function initializeFirebase() {
            try {
                setLogLevel('debug');
                
                // Use the Firebase config provided by the Canvas environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

                // Use Canvas config if available, otherwise use a default (or hardcoded) one.
                const firebaseConfig = firebaseConfigFromCanvas || {
                    apiKey: "AIzaSyCKLZ3BWAl0Z48H0dnprdtn2cTQ7jKlTOg",
                    authDomain: "deseinventory.firebaseapp.com",
                    projectId: "deseinventory",
                    storageBucket: "deseinventory.firebasestorage.app",
                    messagingSenderId: "765936216501",
                    appId: "1:765936216501:web:972c9f9355ca638d81d1fc",
                    measurementId: "G-M2STNJYRP9"
                };

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const mainContainer = document.getElementById('main-container');
                const loadingMessage = document.getElementById('loading-message');

                // Wait for the user to be authenticated before enabling the UI
                onAuthStateChanged(auth, (user) => {
                    console.log("Authentication state changed. User:", user);
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with User ID:", userId);
                        document.getElementById('user-id-display').textContent = `Team Collaboration Mode`;
                        
                        startRealtimeListeners(appId);
                        
                        // Show the main UI and hide the loading message
                        mainContainer.classList.remove('hidden');
                        loadingMessage.classList.add('hidden');
                        showMessage("Database connected and ready!", "success");

                    } else {
                        console.log("No user is signed in. Attempting anonymous sign-in.");
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            document.getElementById('user-id-display').textContent = `Failed to connect.`;
                            loadingMessage.textContent = 'Failed to connect to the database. Please check your network and try again.';
                            mainContainer.classList.add('hidden');
                            loadingMessage.classList.remove('hidden');
                        });
                    }
                });

                if (initialAuthToken) {
                    // Try to sign in with the provided token first
                    await signInWithCustomToken(auth, initialAuthToken).catch(error => {
                        console.error("Custom token sign-in failed:", error);
                        // Fallback to onAuthStateChanged which will handle the anonymous sign-in
                    });
                }
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Failed to connect to the database. Check the console for errors.", "error");
            }
        }

        // Renders the inventory table based on the provided data
        function renderInventoryTable(data) {
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            
            if (data.length === 0) {
                inventoryList.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No matching items found.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 transition-colors duration-200';
                row.innerHTML = `
                    <td class="p-4">${item.name || 'N/A'}</td>
                    <td class="p-4">${item.partNumber || 'N/A'}</td>
                    <td class="p-4">${item.package || 'N/A'}</td>
                    <td class="p-4 text-center font-bold">${item.stockIn || 0}</td>
                    <td class="p-4 text-center font-bold">${item.stockOut || 0}</td>
                    <td class="p-4 text-center font-bold">${item.totalQuantity || 0}</td>
                    <td class="p-4">${item.lastUpdated?.toDate().toLocaleString() || 'N/A'}</td>
                    <td class="p-4 text-center">
                        <button class="edit-btn px-4 py-2 bg-yellow-500 text-white font-semibold rounded-full shadow-md hover:bg-yellow-600 transition-colors duration-200" data-item-id="${item.barcode}">Edit</button>
                    </td>
                `;
                inventoryList.appendChild(row);
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemId = event.target.dataset.itemId;
                    const item = inventoryData[itemId];
                    if (item) {
                        currentItemToEdit = item;
                        populateEditForm(item);
                        switchView('edit-view');
                    }
                });
            });
        }

        function populateEditForm(item) {
            document.getElementById('edit-item-name').value = item.name || '';
            document.getElementById('edit-part-number').value = item.partNumber || '';
            document.getElementById('edit-package').value = item.package || '';
            document.getElementById('edit-quantity').value = item.totalQuantity || 0;
            document.getElementById('edit-item-name').focus();
        }

        async function handleEditForm(event) {
            event.preventDefault();
            if (!currentItemToEdit) {
                showMessage("No item selected for editing.", "error", 'message-box-edit');
                return;
            }

            const newName = document.getElementById('edit-item-name').value.trim();
            const newPartNumber = document.getElementById('edit-part-number').value.trim();
            const newPackage = document.getElementById('edit-package').value.trim();
            const newQuantity = parseInt(document.getElementById('edit-quantity').value.trim(), 10);
            
            if (!newName || !newPartNumber || !newPackage || isNaN(newQuantity) || newQuantity < 0) {
                showMessage("Invalid input. Please fill out all fields correctly.", "error", 'message-box-edit');
                return;
            }

            if (!db || !userId) {
                showMessage("Database not connected. Please refresh the page.", "error", 'message-box-edit');
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const oldBarcode = currentItemToEdit.barcode;
            // FIX: Include package in the new barcode
            const newBarcode = `${newName.replace(/\s/g, '').toLowerCase()}-${newPartNumber.replace(/\s/g, '').toLowerCase()}-${newPackage.replace(/\s/g, '').toLowerCase()}`;

            try {
                // If the barcode changes (due to name or part number or package change), we need to create a new document
                // and delete the old one. Otherwise, just update the existing document.
                if (oldBarcode !== newBarcode) {
                    const newRef = doc(db, `artifacts/${appId}/${FIREBASE_PATH}/inventory`, newBarcode);
                    await setDoc(newRef, {
                        ...currentItemToEdit,
                        barcode: newBarcode,
                        name: newName,
                        partNumber: newPartNumber,
                        package: newPackage,
                        totalQuantity: newQuantity,
                        lastUpdated: serverTimestamp()
                    });
                    await deleteDoc(doc(db, `artifacts/${appId}/${FIREBASE_PATH}/inventory`, oldBarcode));
                } else {
                    const itemRef = doc(db, `artifacts/${appId}/${FIREBASE_PATH}/inventory`, oldBarcode);
                    await updateDoc(itemRef, {
                        name: newName,
                        partNumber: newPartNumber,
                        package: newPackage,
                        totalQuantity: newQuantity,
                        lastUpdated: serverTimestamp()
                    });
                }

                showMessage("Item updated successfully!", "success", 'message-box-edit');
                currentItemToEdit = null;
                document.getElementById('edit-form').reset();
                switchView('inventory-view');
            } catch (e) {
                console.error("Error updating item:", e);
                showMessage(`Error updating item. Check console for details.`, "error", 'message-box-edit');
            }
        }
        
        // Listen for real-time inventory and transaction updates
        function startRealtimeListeners(appId) {
            if (!db || !userId || !appId) {
                console.error("Database, User ID or App ID not available for listeners.");
                return;
            }
            const inventoryCollectionPath = `artifacts/${appId}/${FIREBASE_PATH}/inventory`;
            console.log(`Attempting to listen to inventory at path: ${inventoryCollectionPath}`);
            const inventoryCollectionRef = collection(db, inventoryCollectionPath);
            onSnapshot(inventoryCollectionRef, (querySnapshot) => {
                inventoryData = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    inventoryData[data.barcode] = data;
                });
                // Initially render the full list
                renderInventoryTable(Object.values(inventoryData));
            }, (error) => {
                console.error("Failed to fetch real-time inventory updates:", error);
                showMessage("Failed to sync inventory. Please refresh.", "error");
            });

            const transactionsCollectionPath = `artifacts/${appId}/${FIREBASE_PATH}/transactions`;
            console.log(`Attempting to listen to transactions at path: ${transactionsCollectionPath}`);
            const transactionsCollectionRef = collection(db, transactionsCollectionPath);
            onSnapshot(transactionsCollectionRef, (querySnapshot) => {
                const transactionsList = document.getElementById('transactions-list');
                transactionsList.innerHTML = '';
                transactionsData = [];
                studentSrMap = {}; // Reset the map
                let hasStockOut = false;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactionsData.push(data);
                    
                    if (data.type === 'out') {
                        hasStockOut = true;
                        // Populate the studentSrMap for auto-fill functionality
                        if (data.studentName) {
                            studentSrMap[data.studentName.toLowerCase()] = data.srNumber;
                        }
                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50 transition-colors duration-200';
                        row.innerHTML = `
                            <td class="p-4">${data.studentName || 'N/A'}</td>
                            <td class="p-4">${data.srNumber || 'N/A'}</td>
                            <td class="p-4">${data.name || 'N/A'}</td>
                            <td class="p-4">${data.partNumber || 'N/A'}</td>
                            <td class="p-4">${data.package || 'N/A'}</td>
                            <td class="p-4 text-center font-bold">${data.quantity || 0}</td>
                            <td class="p-4">${data.timestamp?.toDate().toLocaleString() || 'N/A'}</td>
                        `;
                        transactionsList.appendChild(row);
                    }
                });
                
                if (!hasStockOut) {
                    transactionsList.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No stock out transactions yet.</td></tr>';
                }

            }, (error) => {
                console.error("Failed to fetch real-time transaction updates:", error);
                showMessage("Failed to sync transactions. Please refresh.", "error");
            });
        }
        
        // --- NEW LOGIC FOR STUDENT NAME AUTO-FILL ---
        function handleStudentNameInput(event) {
            const typedName = event.target.value.trim().toLowerCase();
            const srNumberInput = document.getElementById('stock-out-sr-number');
            const studentMessage = document.getElementById('student-autofill-message');

            if (typedName.length > 0) {
                const existingSrNumber = studentSrMap[typedName];
                if (existingSrNumber) {
                    srNumberInput.value = existingSrNumber;
                    srNumberInput.disabled = true;
                    srNumberInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    srNumberInput.classList.add('bg-blue-100', 'cursor-default');
                    studentMessage.textContent = 'SR Number auto-filled from history.';
                    studentMessage.className = 'text-green-600 font-semibold';
                } else {
                    srNumberInput.value = '';
                    srNumberInput.disabled = false;
                    srNumberInput.classList.remove('bg-blue-100', 'cursor-default');
                    srNumberInput.classList.add('bg-gray-50');
                    studentMessage.textContent = 'New student. Please enter SR Number.';
                    studentMessage.className = 'text-yellow-600 font-semibold';
                }
            } else {
                srNumberInput.value = '';
                srNumberInput.disabled = true;
                srNumberInput.classList.remove('bg-blue-100', 'cursor-default');
                srNumberInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                studentMessage.textContent = '';
            }
        }
        // --- END OF NEW LOGIC ---

        // --- NEW LOGIC FOR STOCK-OUT FORM ---
        function handleItemNameInput(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            const partNumberInput = document.getElementById('stock-out-part-number');
            const packageInput = document.getElementById('stock-out-package');
            const suggestionsContainer = document.getElementById('item-suggestions');
            const messageBox = document.getElementById('autofill-message-stock-out');

            // Reset fields and suggestions
            partNumberInput.value = '';
            packageInput.value = '';
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            messageBox.textContent = '';
            
            if (searchTerm.length === 0) return;

            const matches = Object.values(inventoryData).filter(item => 
                item.name && item.name.toLowerCase().includes(searchTerm)
            );
            
            if (matches.length === 1) {
                const item = matches[0];
                document.getElementById('stock-out-item-name').value = item.name || '';
                partNumberInput.value = item.partNumber || '';
                packageInput.value = item.package || '';
                messageBox.textContent = 'Item found! Part number and package autofilled.';
                messageBox.className = 'text-green-600 font-semibold';
            } else if (matches.length > 1) {
                messageBox.textContent = 'Multiple items found. Please select from the list.';
                messageBox.className = 'text-yellow-600 font-semibold';
                suggestionsContainer.classList.remove('hidden');
                
                matches.forEach(item => {
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.className = 'flex justify-between items-center p-3 border-b border-gray-200 hover:bg-gray-100 transition-colors duration-200 cursor-pointer rounded-xl';
                    suggestionDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Part Number: ${item.partNumber || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Package: ${item.package || 'N/A'}</p>
                        </div>
                        <button type="button" class="select-btn px-4 py-2 bg-indigo-500 text-white font-semibold rounded-full hover:bg-indigo-600 transition-colors duration-200"
                                data-item-name="${item.name}" data-part-number="${item.partNumber}" data-package="${item.package}">Select</button>
                    `;
                    suggestionsContainer.appendChild(suggestionDiv);
                });
                
                document.querySelectorAll('.select-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const selectedItemName = e.target.dataset.itemName;
                        const selectedPartNumber = e.target.dataset.partNumber;
                        const selectedPackage = e.target.dataset.package;

                        document.getElementById('stock-out-item-name').value = selectedItemName;
                        partNumberInput.value = selectedPartNumber;
                        packageInput.value = selectedPackage;
                        suggestionsContainer.classList.add('hidden');
                        messageBox.textContent = 'Item selected. You can now proceed.';
                        messageBox.className = 'text-green-600 font-semibold';
                    });
                });
            } else {
                messageBox.textContent = 'No item found with this name.';
                messageBox.className = 'text-red-600 font-semibold';
            }
        }
        // --- END OF NEW LOGIC ---

        // General function to handle all stock updates (in and out)
        async function updateInventory(name, studentName, srNumber, partNumber, packageValue, quantity, action, messageBoxId) {
            if (!name || !partNumber || !packageValue || isNaN(quantity) || quantity <= 0) {
                showMessage("Invalid item name, part number, package, or quantity.", "error", messageBoxId);
                return;
            }
            if (!db || !userId) {
                showMessage("Database not connected. Please refresh the page.", "error", messageBoxId);
                return;
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // FIX: Include package in the barcode to ensure uniqueness
            const barcode = `${name.replace(/\s/g, '').toLowerCase()}-${partNumber.replace(/\s/g, '').toLowerCase()}-${packageValue.replace(/\s/g, '').toLowerCase()}`;
            const displayBarcode = "N/A";
            const itemRef = doc(db, `artifacts/${appId}/${FIREBASE_PATH}/inventory`, barcode);
            
            try {
                const itemDoc = await getDoc(itemRef);
                const currentQuantity = itemDoc.exists() ? itemDoc.data().totalQuantity : 0;
                
                // --- FIX FOR NEGATIVE STOCK GLITCH ---
                if (action === 'out' && quantity > currentQuantity) {
                    showMessage(`Error: Cannot stock out ${quantity} units. Only ${currentQuantity} are available.`, "error", messageBoxId);
                    return;
                }
                // --- END OF FIX ---

                const updateData = {
                    totalQuantity: increment(action === 'in' ? quantity : -quantity),
                    lastUpdated: serverTimestamp(),
                    lastStockIn: action === 'in' ? serverTimestamp() : itemDoc.data()?.lastStockIn,
                    lastStockOut: action === 'out' ? serverTimestamp() : itemDoc.data()?.lastStockOut,
                    displayBarcode: displayBarcode
                };

                if (action === 'in') {
                    updateData.stockIn = increment(quantity);
                    if (name) updateData.name = name;
                    if (partNumber) updateData.partNumber = partNumber;
                    if (packageValue) updateData.package = packageValue;
                } else {
                    updateData.stockOut = increment(quantity);
                    if (name) updateData.name = name;
                    if (partNumber) updateData.partNumber = partNumber;
                    if (packageValue) updateData.package = packageValue;
                }

                if (itemDoc.exists()) {
                    await updateDoc(itemRef, updateData);
                } else {
                    const newDoc = {
                        barcode: barcode,
                        displayBarcode: displayBarcode,
                        name: name,
                        partNumber: partNumber,
                        package: packageValue,
                        totalQuantity: quantity,
                        stockIn: action === 'in' ? quantity : 0,
                        stockOut: action === 'out' ? quantity : 0,
                        lastStockIn: action === 'in' ? serverTimestamp() : null,
                        lastStockOut: action === 'out' ? serverTimestamp() : null,
                        lastUpdated: serverTimestamp()
                    };
                    await setDoc(itemRef, newDoc);
                }

                // Create a transaction document for history
                const transactionDoc = {
                    type: action,
                    barcode: barcode,
                    displayBarcode: displayBarcode,
                    name: name,
                    partNumber: partNumber,
                    package: packageValue,
                    quantity: quantity,
                    timestamp: serverTimestamp(),
                    // Only include these fields for stock-out transactions
                    studentName: action === 'out' ? (studentName || 'N/A') : 'N/A',
                    srNumber: action === 'out' ? (srNumber || 'N/A') : 'N/A',
                };
                const transactionsCollectionRef = collection(db, `artifacts/${appId}/${FIREBASE_PATH}/transactions`);
                await addDoc(transactionsCollectionRef, transactionDoc);

                showMessage(`Stock ${action === 'in' ? 'In' : 'Out'} successful for: ${name}!`, 'success', messageBoxId);
                
            } catch (e) {
                console.error("Error updating stock:", e);
                showMessage(`Error updating stock. Check console for details.`, "error", messageBoxId);
            }
        }

        async function handleStockInForm(event) {
            event.preventDefault();
            const itemName = document.getElementById('stock-in-item-name').value.trim();
            const partNumber = document.getElementById('stock-in-part-number').value.trim();
            const packageValue = document.getElementById('stock-in-package').value.trim();
            const quantity = parseInt(document.getElementById('stock-in-quantity').value.trim(), 10);
            
            // Check for required fields: itemName, partNumber, and quantity.
            if (!itemName || !partNumber || !packageValue || quantity <= 0) {
                showMessage("Please fill out all required fields correctly.", "error", 'message-box-stock-in');
                return;
            }

            await updateInventory(itemName, null, null, partNumber, packageValue, quantity, 'in', 'message-box-stock-in');
            document.getElementById('stock-in-form').reset();
            document.getElementById('stock-in-item-name').focus(); 
        }

        async function handleStockOutForm(event) {
            event.preventDefault();
            const quantity = parseInt(document.getElementById('stock-out-quantity').value.trim(), 10);
            const itemName = document.getElementById('stock-out-item-name').value.trim();
            const studentName = document.getElementById('stock-out-student-name').value.trim();
            const partNumber = document.getElementById('stock-out-part-number').value.trim();
            const srNumber = document.getElementById('stock-out-sr-number').value.trim();
            
            // Package information will be automatically filled from the database.
            const packageValue = document.getElementById('stock-out-package').value.trim();

            if (itemName && partNumber && quantity > 0) {
                await updateInventory(itemName, studentName, srNumber, partNumber, packageValue, quantity, 'out', 'message-box-stock-out');
                document.getElementById('stock-out-form').reset();
                // Set focus back to the first input field after successful transaction
                document.getElementById('stock-out-student-name').focus();
            } else {
                showMessage("Please fill out item name, part number, and quantity correctly.", "error", 'message-box-stock-out');
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && event.target.form?.id === 'stock-out-form') {
                // Special handling for the student name field to skip the disabled SR number field
                if (event.target.id === 'stock-out-student-name') {
                    const srNumberInput = document.getElementById('stock-out-sr-number');
                    // Check if the SR Number field has been auto-filled (i.e., is disabled)
                    if (srNumberInput.disabled) {
                        event.preventDefault();
                        document.getElementById('stock-out-item-name').focus();
                        return;
                    }
                }
                
                const form = event.target.form;
                const formFields = Array.from(form.elements).filter(el => el.tagName === 'INPUT');
                const currentIndex = formFields.indexOf(event.target);
                
                // If it's the last input field, let the form submit.
                if (currentIndex === formFields.length - 1) {
                    return;
                }
                
                // For all other fields, prevent the default 'Enter' behavior (submission)
                // and move focus to the next field.
                event.preventDefault();
                const nextIndex = currentIndex + 1;
                if (nextIndex < formFields.length) {
                    formFields[nextIndex].focus();
                }
            }
        });
        
        // Function to export current inventory to CSV
        function exportInventoryToCsv() {
            if (Object.keys(inventoryData).length === 0) {
                showMessage("No inventory data to export.", "error");
                return;
            }

            const header = "Item Name,Part Number,Package,Stock In Count,Stock Out Count,Available Stock,Last Updated\n";
            let csv = header;

            Object.values(inventoryData).forEach(item => {
                const lastUpdated = item.lastUpdated?.toDate().toLocaleString() || 'N/A';
                const row = `"${item.name || 'N/A'}","${item.partNumber || 'N/A'}","${item.package || 'N/A'}",${item.stockIn || 0},${item.stockOut || 0},${item.totalQuantity || 0},"${lastUpdated}"\n`;
                csv += row;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const timestamp = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `inventory-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("Inventory data exported successfully!", "success");
        }

        // Function to export transaction history to CSV
        function exportTransactionsToCsv() {
            const stockOutTransactions = transactionsData.filter(t => t.type === 'out');
            if (stockOutTransactions.length === 0) {
                showMessage("No stock out transactions to export.", "error");
                return;
            }

            const header = "Student Name,SR Number,Item Name,Part Number,Package,Quantity,Timestamp\n";
            let csv = header;

            stockOutTransactions.forEach(transaction => {
                const timestamp = transaction.timestamp?.toDate().toLocaleString() || 'N/A';
                const row = `"${transaction.studentName || 'N/A'}","${transaction.srNumber || 'N/A'}","${transaction.name || 'N/A'}","${transaction.partNumber || 'N/A'}","${transaction.package || 'N/A'}",${transaction.quantity},"${timestamp}"\n`;
                csv += row;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const timestamp = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `transactions-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("Transaction history exported successfully!", "success");
        }

        // Function to import data from a CSV file
        function importFromCsv(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                if (lines.length <= 1) {
                    showMessage("CSV file is empty or has no data.", "error");
                    return;
                }
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const updates = [];
                // Use the header to find the column indices dynamically
                const header = lines[0].split(',').map(h => h.trim().toLowerCase());
                const itemNameIndex = header.indexOf('item name');
                // Check for 'part number' first, then 'part name' as a fallback
                const partNumberIndex = header.indexOf('part number') !== -1 ? header.indexOf('part number') : header.indexOf('part name');
                const packageIndex = header.indexOf('package');
                // Use 'stock in count' as the source for quantity
                const stockIndex = header.indexOf('stock in count');
                
                // Now, check if all required columns are found
                if (itemNameIndex === -1 || partNumberIndex === -1 || packageIndex === -1 || stockIndex === -1) {
                    showMessage("CSV file must contain 'Item Name', 'Part Number' (or 'Part Name'), 'Package', and 'Stock In Count' columns.", "error");
                    return;
                }

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const values = line.match(/(?:\"[^\"]*\"|[^,])+/g);
                        if (values && values.length > 0) {
                            const itemName = (values[itemNameIndex] || '').replace(/"/g, '').trim();
                            const partNumber = (values[partNumberIndex] || '').replace(/"/g, '').trim();
                            const packageValue = (values[packageIndex] || '').replace(/"/g, '').trim();
                            const quantity = parseInt((values[stockIndex] || '0').replace(/"/g, '').trim(), 10);
                            
                            if (itemName && partNumber && packageValue && !isNaN(quantity)) {
                                // FIX: Include package in the barcode during CSV import
                                const barcode = `${itemName.replace(/\s/g, '').toLowerCase()}-${partNumber.replace(/\s/g, '').toLowerCase()}-${packageValue.replace(/\s/g, '').toLowerCase()}`;
                                const itemRef = doc(db, `artifacts/${appId}/${FIREBASE_PATH}/inventory`, barcode);
                                updates.push(setDoc(itemRef, {
                                    barcode: barcode,
                                    name: itemName,
                                    partNumber: partNumber,
                                    package: packageValue,
                                    totalQuantity: increment(quantity),
                                    stockIn: increment(quantity),
                                    lastUpdated: serverTimestamp(),
                                }, { merge: true }));
                            }
                        }
                    }
                }
                
                try {
                    await Promise.all(updates);
                    showMessage(`Successfully imported ${updates.length} items from CSV!`, "success");
                    document.getElementById('csv-file-input').value = null;
                } catch (e) {
                    console.error("Error importing data:", e);
                    showMessage("Error importing data. Check console for details.", "error");
                }
            };
            reader.readAsText(file);
        }
        
        // Function to clear all inventory from the database
        async function clearInventory() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const inventoryCollectionRef = collection(db, `artifacts/${appId}/${FIREBASE_PATH}/inventory`);
            
            try {
                const querySnapshot = await getDocs(inventoryCollectionRef);
                const deletePromises = [];
                
                if (querySnapshot.empty) {
                    showMessage("Inventory is already empty!", "info");
                    return;
                }
                
                querySnapshot.forEach((docu) => {
                    deletePromises.push(deleteDoc(doc(db, `artifacts/${appId}/${FIREBASE_PATH}/inventory`, docu.id)));
                });
                
                await Promise.all(deletePromises);
                showMessage("All inventory items have been successfully cleared!", "success");

            } catch (e) {
                console.error("Error clearing inventory:", e);
                showMessage("An error occurred while clearing the inventory. Check the console.", "error");
            }
        }

        // Function to clear all transactions from the database
        async function clearTransactions() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const transactionsCollectionRef = collection(db, `artifacts/${appId}/${FIREBASE_PATH}/transactions`);

            try {
                const querySnapshot = await getDocs(transactionsCollectionRef);
                
                if (querySnapshot.empty) {
                    showMessage("Transaction history is already empty!", "info");
                    return;
                }

                const batch = writeBatch(db);
                querySnapshot.forEach((docu) => {
                    batch.delete(docu.ref);
                });

                await batch.commit();
                showMessage("All transaction history has been successfully cleared!", "success");
            } catch (e) {
                console.error("Error clearing transactions:", e);
                showMessage("An error occurred while clearing transaction history.", "error");
            }
        }
        
        // Function to switch between views and update mode
        function switchView(viewId) {
            const views = ['stock-out-view', 'stock-in-view', 'inventory-view', 'transactions-view', 'edit-view'];
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');

            const buttons = {
                'stock-out-view': 'stock-out-btn',
                'stock-in-view': 'stock-in-btn',
                'inventory-view': 'view-inventory-btn',
                'transactions-view': 'view-transactions-btn',
                'edit-view': null,
            };
            
            Object.values(buttons).filter(id => id).forEach(buttonId => {
                document.getElementById(buttonId).classList.remove('bg-indigo-600', 'text-white');
                document.getElementById(buttonId).classList.add('bg-gray-300', 'text-gray-800');
            });
            if (buttons[viewId]) {
                document.getElementById(buttons[viewId]).classList.remove('bg-gray-300', 'text-gray-800');
                document.getElementById(buttons[viewId]).classList.add('bg-indigo-600', 'text-white');
            }
            
            document.getElementById('confirm-clear-btn').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            
            // UI button handlers
            document.getElementById('stock-out-btn').addEventListener('click', () => switchView('stock-out-view'));
            document.getElementById('stock-in-btn').addEventListener('click', () => switchView('stock-in-view'));
            document.getElementById('view-inventory-btn').addEventListener('click', () => switchView('inventory-view'));
            document.getElementById('view-transactions-btn').addEventListener('click', () => switchView('transactions-view'));

            document.getElementById('stock-in-form').addEventListener('submit', handleStockInForm);
            document.getElementById('stock-out-form').addEventListener('submit', handleStockOutForm);
            document.getElementById('edit-form').addEventListener('submit', handleEditForm);
            document.getElementById('cancel-edit-btn').addEventListener('click', () => switchView('inventory-view'));

            document.getElementById('export-inventory-btn').addEventListener('click', exportInventoryToCsv);
            document.getElementById('export-transactions-btn').addEventListener('click', exportTransactionsToCsv);
            document.getElementById('csv-file-input').addEventListener('change', importFromCsv);
            
            document.getElementById('clear-btn').addEventListener('click', () => {
                document.getElementById('confirm-clear-btn').classList.remove('hidden');
            });
            document.getElementById('clear-transactions-btn').addEventListener('click', () => {
                 document.getElementById('clear-transactions-modal').classList.remove('hidden');
            });
            document.getElementById('confirm-clear-transactions-btn').addEventListener('click', async () => {
                await clearTransactions();
                document.getElementById('clear-transactions-modal').classList.add('hidden');
            });
            document.getElementById('cancel-clear-transactions-btn').addEventListener('click', () => {
                document.getElementById('clear-transactions-modal').classList.add('hidden');
            });
            document.getElementById('confirm-clear-btn').addEventListener('click', async () => {
                await clearInventory();
                document.getElementById('confirm-clear-btn').classList.add('hidden');
            });

            // New search bar for inventory
            document.getElementById('inventory-search').addEventListener('input', (event) => {
                const searchTerm = event.target.value.toLowerCase().trim();
                const filteredItems = Object.values(inventoryData).filter(item => {
                    // Check if stock is available
                    const hasStock = item.totalQuantity > 0;
                    
                    if (!hasStock) return false;

                    // Check if search term matches any key fields
                    const itemName = (item.name || '').toLowerCase().includes(searchTerm);
                    const partNumber = (item.partNumber || '').toLowerCase().includes(searchTerm);
                    const packageValue = (item.package || '').toLowerCase().includes(searchTerm);
                    
                    return itemName || partNumber || packageValue;
                });
                renderInventoryTable(filteredItems);
            });
            
            // Event listener for the student name auto-fill
            document.getElementById('stock-out-student-name').addEventListener('input', handleStudentNameInput);

            // Event listener for the item name search logic
            document.getElementById('stock-out-item-name').addEventListener('input', handleItemNameInput);


            // Set initial view
            switchView('stock-out-view');
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Header and Navigation -->
    <header class="w-full max-w-4xl text-center py-6">
        <div class="flex items-center justify-center mb-4">
            <h1 class="text-4xl font-extrabold text-gray-800">DESE Electronics Inventory Management</h1>
        </div>
        <p class="text-gray-500 mt-2" id="user-id-display">Connecting to database...</p>
        <div class="flex justify-center space-x-4 mt-6">
            <button id="stock-out-btn" class="px-6 py-2 font-semibold rounded-full shadow-lg transition-colors duration-200">
                Stock Out
            </button>
            <button id="stock-in-btn" class="px-6 py-2 font-semibold rounded-full shadow-lg transition-colors duration-200">
                Stock In
            </button>
            <button id="view-inventory-btn" class="px-6 py-2 font-semibold rounded-full shadow-lg transition-colors duration-200">
                Current Inventory
            </button>
            <button id="view-transactions-btn" class="px-6 py-2 font-semibold rounded-full shadow-lg transition-colors duration-200">
                Transaction History
            </button>
        </div>
    </header>

    <!-- Main Views Container -->
    <main id="main-container" class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-8 mt-6 hidden">

        <!-- Stock Out View -->
        <section id="stock-out-view" class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Stock Out</h2>
            <p class="text-center text-sm text-gray-500">
                Manually enter item details to remove from stock.
            </p>
            <form id="stock-out-form" class="space-y-4">
                <input type="text" id="stock-out-student-name" placeholder="Student Name" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <div id="student-autofill-message" class="w-full text-center text-sm h-4"></div>
                <input type="text" id="stock-out-sr-number" placeholder="SR Number" disabled class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200 bg-gray-100 cursor-not-allowed">
                <input type="text" id="stock-out-item-name" placeholder="Item Name" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <input type="text" id="stock-out-part-number" placeholder="Part Number" readonly class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200 bg-gray-100 cursor-not-allowed">
                <input type="text" id="stock-out-package" placeholder="Package" readonly class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200 bg-gray-100 cursor-not-allowed">
                <div id="autofill-message-stock-out" class="w-full text-center text-sm h-4"></div>
                <!-- New element to show suggestions -->
                <div id="item-suggestions" class="w-full space-y-2 mt-4 hidden"></div>
                <input type="number" id="stock-out-quantity" placeholder="Quantity to remove" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <button type="submit" class="w-full px-6 py-3 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors duration-200 shadow-lg">Remove from Stock</button>
            </form>
            <div id="message-box-stock-out" class="w-full h-12"></div>
        </section>

        <!-- Stock In View -->
        <section id="stock-in-view" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Stock In</h2>
            <p class="text-center text-sm text-gray-500">
                Add new items or update existing stock.
            </p>
            <form id="stock-in-form" class="space-y-4">
                <input type="text" id="stock-in-item-name" placeholder="Item Name" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <input type="text" id="stock-in-part-number" placeholder="Part Number" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <input type="text" id="stock-in-package" placeholder="Package" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <input type="number" id="stock-in-quantity" placeholder="Quantity to add" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <button type="submit" class="w-full px-6 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors duration-200 shadow-lg">Add to Stock</button>
            </form>
            <div id="message-box-stock-in" class="w-full h-12"></div>
        </section>

        <!-- Current Inventory View -->
        <section id="inventory-view" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Current Inventory</h2>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                <label for="csv-file-input" class="cursor-pointer px-6 py-2 bg-gray-500 text-white font-semibold rounded-full shadow-lg hover:bg-gray-600 transition-colors duration-200">
                    Import from CSV
                </label>
                <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                <button id="export-inventory-btn" class="px-6 py-2 bg-teal-500 text-white font-semibold rounded-full shadow-lg hover:bg-teal-600 transition-colors duration-200">
                    Export Inventory to CSV
                </button>
                <button id="clear-btn" class="px-6 py-2 bg-red-500 text-white font-semibold rounded-full shadow-lg hover:bg-red-600 transition-colors duration-200">
                    Clear Inventory
                </button>
                <button id="confirm-clear-btn" class="px-6 py-2 bg-red-700 text-white font-semibold rounded-full shadow-lg hover:bg-red-800 transition-colors duration-200 hidden">
                    Confirm Clear
                </button>
            </div>
            <!-- New search bar for inventory -->
            <input type="text" id="inventory-search" placeholder="Search items with stock available..." class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
            <div class="overflow-x-auto rounded-lg shadow-inner">
                <table class="min-w-full bg-white rounded-lg border-collapse">
                    <thead class="bg-gray-200 text-gray-700">
                        <tr>
                            <th class="p-4 text-left font-semibold">Item Name</th>
                            <th class="p-4 text-left font-semibold">Part Number</th>
                            <th class="p-4 text-left font-semibold">Package</th>
                            <th class="p-4 text-center font-semibold">Stock In</th>
                            <th class="p-4 text-center font-semibold">Stock Out</th>
                            <th class="p-4 text-center font-semibold">Available Stock</th>
                            <th class="p-4 text-left font-semibold">Last Updated</th>
                            <th class="p-4 text-center font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list" class="divide-y divide-gray-200">
                        <!-- Inventory rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Edit Item View -->
        <section id="edit-view" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Edit Item</h2>
            <p class="text-center text-sm text-gray-500">
                Modify item details and quantity.
            </p>
            <form id="edit-form" class="space-y-4">
                <input type="text" id="edit-item-name" placeholder="Item Name" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <input type="text" id="edit-part-number" placeholder="Part Number" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <input type="text" id="edit-package" placeholder="Package" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <input type="number" id="edit-quantity" placeholder="Available Quantity" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                <div class="flex space-x-4">
                    <button type="submit" class="w-full px-6 py-3 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors duration-200 shadow-lg">Save Changes</button>
                    <button type="button" id="cancel-edit-btn" class="w-full px-6 py-3 rounded-xl bg-gray-500 text-white font-semibold hover:bg-gray-600 transition-colors duration-200 shadow-lg">Cancel</button>
                </div>
            </form>
            <div id="message-box-edit" class="w-full h-12"></div>
        </section>

        <!-- Transaction History View -->
        <section id="transactions-view" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Transaction History</h2>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                <button id="export-transactions-btn" class="px-6 py-2 bg-teal-500 text-white font-semibold rounded-full shadow-lg hover:bg-teal-600 transition-colors duration-200">
                    Export Transactions to CSV
                </button>
                <button id="clear-transactions-btn" class="px-6 py-2 bg-red-500 text-white font-semibold rounded-full shadow-lg hover:bg-red-600 transition-colors duration-200">
                    Clear Transaction History
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-inner">
                <table class="min-w-full bg-white rounded-lg border-collapse">
                    <thead class="bg-gray-200 text-gray-700">
                        <tr>
                            <th class="p-4 text-left font-semibold">Student Name</th>
                            <th class="p-4 text-left font-semibold">SR Number</th>
                            <th class="p-4 text-left font-semibold">Item Name</th>
                            <th class="p-4 text-left font-semibold">Part Number</th>
                            <th class="p-4 text-left font-semibold">Package</th>
                            <th class="p-4 text-center font-semibold">Quantity</th>
                            <th class="p-4 text-left font-semibold">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-list" class="divide-y divide-gray-200">
                        <!-- Transaction history rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Loading message -->
    <div id="loading-message" class="w-full max-w-4xl p-8 mt-6 text-center text-gray-500 font-semibold text-xl">
        Connecting to database...
    </div>

    <!-- Clear Transactions Confirmation Modal -->
    <div id="clear-transactions-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm mx-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Are you sure?</h3>
            <p class="text-gray-600 text-center mb-6">This will permanently delete ALL transaction history. This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-clear-transactions-btn" class="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-full hover:bg-gray-400 transition-colors duration-200">
                    Cancel
                </button>
                <button id="confirm-clear-transactions-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-full hover:bg-red-700 transition-colors duration-200">
                    Yes, Clear
                </button>
            </div>
        </div>
    </div>
</body>
</html>
