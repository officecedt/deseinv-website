<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESE Electronics Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- PDF Generation Library (html2pdf.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Ensure getDocs and writeBatch are imported for the new clear functionality
        import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, increment, serverTimestamp, setLogLevel, getDoc, getDocs, deleteDoc, addDoc, writeBatch, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables
        let app, auth, db, userId;
        let inventoryData = {};
        let transactionsData = [];
        let studentSrNos = ['1234', '5678', '9012', '3456']; // Mock SR numbers for quick testing
        
        // --- Utility Functions ---

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with UID:", userId);
                        // Start listening to data once authenticated
                        setupDataListeners();
                        document.getElementById('current-user-id').textContent = userId;
                    } else {
                        console.log("No user is signed in.");
                        userId = null;
                        document.getElementById('current-user-id').textContent = 'Not Authenticated';
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                document.getElementById('app-status').textContent = 'Error initializing Firebase. Check console.';
            }
        }

        /**
         * Sets up real-time listeners for Inventory and Transactions.
         */
        function setupDataListeners() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const inventoryCollectionPath = `artifacts/${appId}/public/data/inventory`;
            const transactionsCollectionPath = `artifacts/${appId}/public/data/transactions`;

            // Inventory Listener
            onSnapshot(collection(db, inventoryCollectionPath), (snapshot) => {
                inventoryData = {};
                snapshot.forEach(doc => {
                    inventoryData[doc.id] = { id: doc.id, ...doc.data() };
                });
                console.log("Inventory Updated:", Object.values(inventoryData).length, "items");
                renderInventory();
            }, (error) => {
                console.error("Error listening to inventory:", error);
            });

            // Transactions Listener
            onSnapshot(query(collection(db, transactionsCollectionPath)), (snapshot) => {
                transactionsData = [];
                snapshot.forEach(doc => {
                    transactionsData.push({ id: doc.id, ...doc.data() });
                });
                // Sort by timestamp descending
                transactionsData.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                console.log("Transactions Updated:", transactionsData.length, "records");
                renderTransactions();
            }, (error) => {
                console.error("Error listening to transactions:", error);
            });
        }

        /**
         * Renders the current inventory items in the table.
         */
        function renderInventory() {
            const inventoryBody = document.getElementById('inventory-table-body');
            if (!inventoryBody) return;

            inventoryBody.innerHTML = '';
            const items = Object.values(inventoryData).filter(item => item.name && item.partNumber); // Basic check for valid data

            if (items.length === 0) {
                inventoryBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No inventory items found. Add a new item to get started.</td></tr>';
                return;
            }

            items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-yellow-50';
                
                // Format cost per unit for display
                const costDisplay = item.costPerUnit ? `₹${item.costPerUnit.toFixed(2)}` : 'FREE';

                row.innerHTML = `
                    <td class="p-3 text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="p-3 text-sm text-gray-500">${item.partNumber}</td>
                    <td class="p-3 text-sm text-gray-500">${item.package}</td>
                    <td class="p-3 text-sm font-bold text-gray-700">${item.quantity || 0}</td>
                    <td class="p-3 text-sm font-semibold text-blue-600">${costDisplay}</td>
                    <td class="p-3 text-sm text-gray-500">${item.maxQuantity || 'N/A'}</td>
                    <td class="p-3 text-sm">
                        <button onclick="openTransactionModal('${item.id}', 'Issue')" class="text-red-500 hover:text-red-700 font-medium mr-2">Issue</button>
                        <button onclick="openTransactionModal('${item.id}', 'Receive')" class="text-green-500 hover:text-green-700 font-medium mr-2">Receive</button>
                        <button onclick="openEditModal('${item.id}')" class="text-yellow-600 hover:text-yellow-800 font-medium">Edit</button>
                    </td>
                `;
                inventoryBody.appendChild(row);
            });
        }

        /**
         * Renders the transaction history.
         */
        function renderTransactions() {
            const transactionBody = document.getElementById('transaction-history-body');
            if (!transactionBody) return;

            transactionBody.innerHTML = '';
            if (transactionsData.length === 0) {
                transactionBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No transaction records found.</td></tr>';
                return;
            }

            transactionsData.forEach(tx => {
                const item = inventoryData[tx.itemId] || { name: 'Unknown Item', partNumber: 'N/A' };
                const date = tx.timestamp ? new Date(tx.timestamp.toMillis()).toLocaleString() : 'N/A';
                
                let typeColor, statusText;
                let issuedQuantity = tx.quantity || 0;
                let returnedQuantity = tx.returnedQuantity || 0;
                let outstandingQuantity = issuedQuantity - returnedQuantity;

                if (tx.type === 'Issue') {
                    if (outstandingQuantity === 0 && tx.isReturned === true) {
                        statusText = 'Returned (Full)';
                        typeColor = 'bg-gray-200 text-gray-800';
                    } else if (outstandingQuantity > 0 && returnedQuantity > 0) {
                        statusText = 'Partial Return';
                        typeColor = 'bg-yellow-100 text-yellow-800';
                    } else if (outstandingQuantity === issuedQuantity) {
                        statusText = 'Issued';
                        typeColor = 'bg-red-100 text-red-800';
                    } else {
                        statusText = 'Issue Record';
                        typeColor = 'bg-red-100 text-red-800';
                    }
                    // Add quantity details to status for clarity
                    statusText += ` (${outstandingQuantity}/${issuedQuantity})`;
                } else {
                    // Receive transaction (Manual Stock Receive)
                    statusText = 'Receive';
                    typeColor = 'bg-green-100 text-green-800';
                }

                
                let fineDisplay = 'N/A';
                // Display the current fine calculated on the OUTSTANDING quantity, stored in tx.totalFine
                if (tx.type === 'Issue' && typeof tx.totalFine === 'number') {
                    // Strike through the fine if it's zero (full return), but show the amount (which is 0.00)
                    fineDisplay = `<span class="${outstandingQuantity === 0 ? 'text-gray-500 line-through' : 'font-bold text-red-600'}">₹${tx.totalFine.toFixed(2)}</span>`;
                }

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="p-3 text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="p-3 text-sm text-gray-500">${item.partNumber}</td>
                    <td class="p-3 text-sm">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${typeColor}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="p-3 text-sm font-semibold">${tx.quantity}</td>
                    <td class="p-3 text-sm text-gray-500">
                        ${tx.studentSrNo ? 
                            `${tx.studentName || 'Student'} (SR No: ${tx.studentSrNo})` 
                            : (tx.receivedBy || 'N/A')}
                    </td>
                    <td class="p-3 text-sm text-gray-500">${date}</td>
                    <td class="p-3 text-sm">${fineDisplay}</td>
                    <td class="p-3 text-sm">
                        ${tx.type === 'Issue' && outstandingQuantity > 0 ? 
                            `<button onclick="printTransactionChallan('${tx.id}')" 
                                     class="text-blue-600 hover:text-blue-800 font-medium disabled:text-gray-400"
                                     title="Download Issue Challan (Current Fine)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    <path d="M10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" />
                                </svg>
                            </button>` 
                            : 'N/A'}
                    </td>
                `;
                transactionBody.appendChild(row);
            });
        }
        
        // --- Core Application Logic ---

        /**
         * Processes a return (full or partial) for a specific outstanding Issue transaction.
         * The fine is recalculated based on the remaining outstanding quantity.
         */
        window.handleProcessReturn = async (issueTxId, quantityToReturnInput) => {
            const tx = transactionsData.find(t => t.id === issueTxId);
            const quantityToReturn = parseInt(quantityToReturnInput, 10);
            
            if (!tx || tx.type !== 'Issue') {
                showMessage('Error: Invalid transaction selected for return.', 'error');
                return;
            }
            if (isNaN(quantityToReturn) || quantityToReturn <= 0) {
                 showMessage('Return failed: Quantity must be greater than zero.', 'error');
                return;
            }

            const initialIssuedQuantity = tx.quantity || 0;
            const alreadyReturned = tx.returnedQuantity || 0;
            const outstandingQuantity = initialIssuedQuantity - alreadyReturned;

            if (quantityToReturn > outstandingQuantity) {
                showMessage(`Return failed: Cannot return ${quantityToReturn} units. Only ${outstandingQuantity} are outstanding.`, 'error');
                return;
            }

            // Get references
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const itemRef = doc(db, `artifacts/${appId}/public/data/inventory`, tx.itemId);
            const issueTxRef = doc(db, `artifacts/${appId}/public/data/transactions`, issueTxId);

            const batch = writeBatch(db);
            
            // 1. Update Inventory Quantity (Receive)
            batch.update(itemRef, { quantity: increment(quantityToReturn) });

            // 2. Update Original Issue Transaction
            const newReturnedQuantity = alreadyReturned + quantityToReturn;
            const newOutstandingQuantity = initialIssuedQuantity - newReturnedQuantity;

            // Recalculate fine based on remaining outstanding quantity (This is the core logic change)
            const costPerUnit = tx.costPerUnit || 0.00;
            const newTotalFine = costPerUnit * newOutstandingQuantity;
            
            const isFullReturn = newOutstandingQuantity === 0;

            const issueUpdate = { 
                returnedQuantity: newReturnedQuantity, 
                totalFine: newTotalFine, // Fine is calculated on the remaining outstanding quantity
                lastReturnTimestamp: serverTimestamp(),
            };
            
            if (isFullReturn) {
                 issueUpdate.isReturned = true; // Mark as fully closed/returned
            } else {
                 // Ensure isReturned is false if it's a partial return
                 issueUpdate.isReturned = false;
            }

            batch.update(issueTxRef, issueUpdate);
            
            try {
                await batch.commit();
                showMessage(`Return successful. ${quantityToReturn} x ${tx.itemName} returned by ${tx.studentName}. Remaining fine for ${newOutstandingQuantity} units is ₹${newTotalFine.toFixed(2)}.`, 'success');
                // Re-open the modal to refresh the outstanding list
                openTransactionModal(tx.itemId, 'Receive');
            } catch (error) {
                console.error("Error processing return:", error);
                showMessage(`Return failed: ${error.message}`, 'error');
            }
        };

        /**
         * Deletes all documents in the Inventory collection.
         */
        window.clearInventory = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            
            try {
                const snapshot = await getDocs(query(collectionRef));
                const batch = writeBatch(db);
                
                if (snapshot.empty) {
                    showMessage('Inventory is already empty.', 'info');
                    return;
                }

                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                showMessage(`Successfully cleared ${snapshot.size} inventory items.`, 'success');
            } catch (error) {
                console.error("Error clearing inventory:", error);
                showMessage(`Failed to clear inventory: ${error.message}`, 'error');
            }
        };

        /**
         * Deletes all documents in the Transactions collection.
         */
        window.clearTransactions = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionRef = collection(db, `artifacts/${appId}/public/data/transactions`);

            try {
                const snapshot = await getDocs(query(collectionRef));
                const batch = writeBatch(db);

                if (snapshot.empty) {
                    showMessage('Transaction history is already empty.', 'info');
                    return;
                }

                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                showMessage(`Successfully cleared ${snapshot.size} transaction records.`, 'success');
            } catch (error) {
                console.error("Error clearing transactions:", error);
                showMessage(`Failed to clear transactions: ${error.message}`, 'error');
            }
        };

        /**
         * Handles the submission of a new item form.
         */
        window.handleAddItem = async (event) => {
            event.preventDefault();
            const form = event.target;
            const newItem = {
                name: form['item-name'].value,
                partNumber: form['part-number'].value,
                package: form['package'].value,
                quantity: parseInt(form['total-quantity'].value, 10) || 0,
                costPerUnit: parseFloat(form['cost-per-unit'].value) || 0.00, // Cost per unit/fine
                // maxQuantity field has been removed from the form and is no longer set here
                createdBy: userId,
                createdAt: serverTimestamp()
            };

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionRef = collection(db, `artifacts/${appId}/public/data/inventory`);

            try {
                await addDoc(collectionRef, newItem);
                form.reset();
                closeModal('add-item-modal');
                showMessage('New item added successfully.', 'success');
            } catch (error) {
                console.error("Error adding item:", error);
                showMessage(`Failed to add item. ${error.message}`, 'error');
            }
        };

        /**
         * Handles the submission of the edit item form.
         */
        window.handleEditItem = async (event) => {
            event.preventDefault();
            const form = event.target;
            const itemId = form['edit-item-id'].value;
            const itemRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/inventory`, itemId);

            const updatedItem = {
                name: form['edit-item-name'].value,
                partNumber: form['edit-part-number'].value,
                package: form['edit-package'].value,
                quantity: parseInt(form['edit-quantity'].value, 10) || 0,
                costPerUnit: parseFloat(form['edit-cost-per-unit'].value) || 0.00, // Cost per unit/fine
                maxQuantity: parseInt(form['edit-max-quantity'].value, 10) || null,
            };

            try {
                await updateDoc(itemRef, updatedItem);
                closeModal('edit-item-modal');
                showMessage('Item updated successfully.', 'success');
            } catch (error) {
                console.error("Error updating item:", error);
                showMessage(`Failed to update item. ${error.message}`, 'error');
            }
        };


        /**
         * Handles the submission of a transaction (Issue or Manual Receive).
         */
        window.handleTransaction = async (event) => {
            event.preventDefault();
            const form = event.target;
            const itemId = form['transaction-item-id'].value;
            const itemRef = doc(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/inventory`, itemId);
            
            const itemDoc = await getDoc(itemRef);
            if (!itemDoc.exists()) {
                showMessage('Transaction failed: Item not found.', 'error');
                return;
            }

            const currentItem = itemDoc.data();
            const type = form['transaction-type'].value;
            const quantityChange = parseInt(form['transaction-quantity'].value, 10);
            const studentSrNo = form['student-sr-no']?.value;
            const studentName = form['student-name']?.value;
            const receivedBy = form['received-by']?.value;

            if (isNaN(quantityChange) || quantityChange <= 0) {
                 showMessage('Transaction failed: Quantity must be greater than zero.', 'error');
                return;
            }

            const transactionData = {
                itemId: itemId,
                type: type,
                quantity: quantityChange,
                timestamp: serverTimestamp(),
                processedBy: userId,
                itemName: currentItem.name,
                partNumber: currentItem.partNumber,
                package: currentItem.package,
            };

            const batch = writeBatch(db);
            let inventoryUpdate;

            if (type === 'Issue') {
                const newQuantity = currentItem.quantity - quantityChange;
                if (newQuantity < 0) {
                    showMessage('Issue failed: Insufficient stock in inventory.', 'error');
                    return;
                }
                // Check if both Name and SR No. are present
                if (!studentSrNo || !studentName) {
                    showMessage('Issue failed: Student Name and SR No. are mandatory.', 'error');
                    return;
                }

                // Calculate Fine
                const costPerUnit = parseFloat(currentItem.costPerUnit) || 0.00;
                const totalFine = costPerUnit * quantityChange;

                inventoryUpdate = { quantity: increment(-quantityChange) };
                transactionData.studentSrNo = studentSrNo;
                transactionData.studentName = studentName;
                transactionData.costPerUnit = costPerUnit;
                transactionData.totalFine = totalFine; // Initial fine based on issued quantity
                transactionData.isReturned = false; // Mark as open/not returned initially
                transactionData.returnedQuantity = 0; // NEW: Initialize returned quantity for tracking

            } else { // Receive (Manual Receive, not linked to specific issue)
                inventoryUpdate = { quantity: increment(quantityChange) };
                transactionData.receivedBy = receivedBy || 'Stock Received';
            }

            // 1. Update Inventory Quantity
            batch.update(itemRef, inventoryUpdate);

            // 2. Add Transaction Record
            const transactionsCollectionRef = collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/transactions`);
            const newTransactionRef = doc(transactionsCollectionRef);
            batch.set(newTransactionRef, transactionData);

            try {
                await batch.commit();
                showMessage(`${type} successful. Item: ${currentItem.name}, Quantity: ${quantityChange}`, 'success');
                closeModal('transaction-modal');
            } catch (error) {
                console.error("Error processing transaction:", error);
                showMessage(`Transaction failed: ${error.message}`, 'error');
            }
        };
        
        // --- PDF Challan Functions ---

        /**
         * Generates the HTML content for the Issue Challan PDF.
         * @param {Object} tx - The transaction object.
         * @returns {string} The HTML string for the challan.
         */
        function generateChallanHTML(tx) {
            // Note: Use stored transaction data for the challan.
            const date = tx.timestamp ? new Date(tx.timestamp.toMillis()).toLocaleString() : 'N/A';
            const transactionId = tx.id;
            const costPerUnit = parseFloat(tx.costPerUnit) || 0;
            const issuedQuantity = tx.quantity || 0;
            const outstandingQuantity = issuedQuantity - (tx.returnedQuantity || 0);
            
            // The displayed fine is the *current* fine based on the outstanding quantity
            const totalFine = parseFloat(tx.totalFine) || 0; 
            
            const totalFineDisplay = totalFine.toFixed(2);
            const costPerUnitDisplay = costPerUnit.toFixed(2);
            
            // This is the HTML that will be used by html2pdf.js to generate the PDF
            return `
                <div id="challan-document" style="padding: 24px; font-family: 'Inter', sans-serif; background-color: #ffffff; border: 1px solid #e5e7eb; max-width: 800px; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <style>
                        /* Minimal styles for PDF consistency */
                        @media print {
                            body { margin: 0; padding: 0; }
                            #challan-document { border: none; box-shadow: none; max-width: 100%; }
                        }
                        .header-main { font-size: 1.75rem; font-weight: 800; color: #1f2937; border-bottom: 3px solid #f59e0b; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
                        .header-sub { font-size: 1rem; color: #6b7280; margin-top: 0.25rem; font-weight: 600; }
                        .info-grid { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
                        .info-box { background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; flex: 1 1 45%; border: 1px solid #e5e7eb; }
                        .info-label { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; font-weight: 500; text-transform: uppercase; }
                        .info-value { font-size: 1rem; font-weight: 600; color: #1f2937; }
                        .table-header { background-color: #fef3c7; color: #92400e; font-size: 0.75rem; font-weight: 700; padding: 0.75rem 1rem; text-align: left; border: 1px solid #fcd34d; }
                        .table-cell { padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; }
                        .total-row { background-color: #fffbeb; font-weight: 700; font-size: 1.1rem; color: #b45309; }
                        .signature-block { border-top: 1px solid #9ca3af; padding-top: 0.5rem; margin-top: 2rem; width: 45%; text-align: center; font-size: 0.875rem; color: #4b5563; }
                    </style>

                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div class="header-main">DESE Electronics Issue Challan (Fine Slip)</div>
                        <div class="header-sub">Record of Stock Issue and Payable Fine</div>
                    </div>

                    <!-- Recipient and Transaction Details -->
                    <div class="info-grid">
                        <div class="info-box">
                            <div class="info-label">Issued To</div>
                            <div class="info-value">${tx.studentName || 'N/A'}</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Student Roll/SR No.</div>
                            <div class="info-value">${tx.studentSrNo || 'N/A'}</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Date of Issue</div>
                            <div class="info-value">${date}</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Transaction ID</div>
                            <div class="info-value" style="font-size: 0.75rem; word-break: break-all;">${transactionId}</div>
                        </div>
                    </div>
                    
                    <!-- Items Table -->
                    <h4 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">Issued Components:</h4>
                    <table style="width: 100%; border-collapse: collapse; border-top: 1px solid #fcd34d;">
                        <thead>
                            <tr>
                                <th class="table-header" style="width: 30%;">Item Name</th>
                                <th class="table-header" style="width: 15%;">Issued Qty</th>
                                <th class="table-header" style="width: 15%;">Outstanding Qty</th>
                                <th class="table-header" style="width: 15%; text-align: right;">Unit Fine (₹)</th>
                                <th class="table-header" style="width: 25%; text-align: right;">Current Payable Fine (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="table-cell">${tx.itemName || 'N/A'}</td>
                                <td class="table-cell">${issuedQuantity}</td>
                                <td class="table-cell font-bold">${outstandingQuantity}</td>
                                <td class="table-cell" style="text-align: right;">${costPerUnitDisplay}</td>
                                <td class="table-cell" style="text-align: right; font-weight: 700; color: #dc2626;">${totalFineDisplay}</td>
                            </tr>
                            <tr class="total-row">
                                <td class="table-cell" colspan="4" style="text-align: right; border: none; padding-top: 1rem; padding-bottom: 1rem;">TOTAL AMOUNT PAYABLE:</td>
                                <td class="table-cell" style="text-align: right; border: none; padding-top: 1rem; padding-bottom: 1rem; color: #dc2626; font-size: 1.25rem;">₹${totalFineDisplay}</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Signatures -->
                    <div style="display: flex; justify-content: space-between; margin-top: 4rem;">
                        <div class="signature-block">
                            <div style="font-weight: 700; margin-bottom: 0.25rem;">_________________________</div>
                            Student Signature<br>(${tx.studentName || 'N/A'})
                        </div>
                        <div class="signature-block">
                            <div style="font-weight: 700; margin-bottom: 0.25rem;">_________________________</div>
                            Inventory Manager<br>(${tx.processedBy || 'N/A'})
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 3rem; font-size: 0.75rem; color: #9ca3af;">
                        NOTE: This slip must be presented at the time of fee payment or component return. The Fine amount reflects the current outstanding quantity.
                    </div>
                </div>
            `;
        }

        /**
         * Fetches transaction details and triggers the PDF generation.
         * @param {string} transactionId - The ID of the transaction to print.
         */
        window.printTransactionChallan = (transactionId) => {
            const tx = transactionsData.find(t => t.id === transactionId);
            
            const outstanding = (tx.quantity || 0) - (tx.returnedQuantity || 0);

            if (!tx || tx.type !== 'Issue' || outstanding <= 0) {
                showMessage('Error: Challan can only be generated for active issue transactions with an outstanding balance.', 'error');
                return;
            }

            const challanHtml = generateChallanHTML(tx);
            const pdfContainer = document.getElementById('pdf-container');
            pdfContainer.innerHTML = challanHtml; // Populate the container

            const filename = `Issue_Challan_${tx.studentSrNo || 'Unknown'}_${tx.itemName.replace(/\s/g, '_')}_${tx.id.substring(0, 6)}.pdf`;
            
            // html2pdf options
            const options = {
                margin: 10,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Generate the PDF from the populated container
            html2pdf().set(options).from(document.getElementById('challan-document')).save().then(() => {
                pdfContainer.innerHTML = ''; // Clean up
                showMessage('Issue Challan downloaded successfully.', 'success');
            }).catch(error => {
                console.error('PDF Generation Failed:', error);
                showMessage('Failed to generate PDF Challan.', 'error');
            });
        };
        
        // --- UI/Modal Management ---

        /**
         * Shows the general message container.
         */
        function showMessage(message, type) {
            const messageEl = document.getElementById('message-box');
            messageEl.textContent = message;
            messageEl.className = 'p-3 rounded-md shadow-lg fixed top-4 right-4 z-50 transition-transform duration-300 transform translate-x-0';
            
            if (type === 'success') {
                messageEl.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                messageEl.classList.add('bg-red-500', 'text-white');
            } else {
                messageEl.classList.add('bg-blue-500', 'text-white');
            }

            setTimeout(() => {
                messageEl.classList.remove('translate-x-0');
                messageEl.classList.add('translate-x-full');
            }, 5000);
        }

        /**
         * Opens a modal by its ID.
         */
        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
        };

        /**
         * Closes a modal by its ID.
         */
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
        };

        /**
         * Opens the generic confirmation modal and sets the callback action.
         */
        window.openConfirmationModal = (actionName, message, callback) => {
            document.getElementById('confirmation-modal-title').textContent = `Confirm ${actionName}`;
            document.getElementById('confirmation-modal-message').textContent = message;
            
            const confirmButton = document.getElementById('confirmation-modal-button');
            confirmButton.textContent = `Confirm ${actionName.split(' ')[1]}`; // e.g., "Confirm Delete" or "Confirm Clear"
            confirmButton.onclick = () => {
                closeModal('confirmation-modal');
                callback();
            };

            openModal('confirmation-modal');
        };
        
        /**
         * Opens the transaction modal and sets up the form based on type (Issue/Receive).
         */
        window.openTransactionModal = (itemId, type) => {
            const item = inventoryData[itemId];
            if (!item) {
                console.error("Item not found for transaction modal.");
                return;
            }

            const modalTitle = document.getElementById('transaction-modal-title');
            const itemInfo = document.getElementById('transaction-item-info');
            const dynamicInputContainer = document.getElementById('dynamic-transaction-input');
            const form = document.getElementById('transaction-form');
            const submitButton = document.getElementById('transaction-submit-button');

            const costDisplay = item.costPerUnit ? `₹${item.costPerUnit.toFixed(2)}/unit` : 'FREE';

            modalTitle.textContent = `${type} Stock: ${item.name} (${item.partNumber})`;
            itemInfo.innerHTML = `Current Quantity: <span class="font-bold text-yellow-600">${item.quantity || 0}</span> | Cost/Unit: <span class="font-bold text-blue-600">${costDisplay}</span>`;
            
            form['transaction-item-id'].value = itemId;
            form['transaction-type'].value = type;
            form['transaction-quantity'].max = type === 'Issue' ? item.quantity : '';
            form['transaction-quantity'].required = true;

            dynamicInputContainer.innerHTML = ''; // Clear previous inputs

            if (type === 'Issue') {
                submitButton.textContent = 'Confirm Issue';
                submitButton.classList.remove('hidden');
                form['transaction-quantity'].value = 1;

                dynamicInputContainer.innerHTML = `
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name (MANDATORY)</label>
                        <input type="text" id="student-name" name="student-name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="student-sr-no" class="block text-sm font-medium text-gray-700">Student SR No. (MANDATORY)</label>
                        <input type="text" id="student-sr-no" name="student-sr-no" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500"
                               list="student-sr-suggestions">
                        <datalist id="student-sr-suggestions">
                            ${studentSrNos.map(sr => `<option value="${sr}">`).join('')}
                        </datalist>
                    </div>
                `;
            } else { // Receive
                submitButton.textContent = 'Confirm Manual Receive';
                // For manual receive, quantity field is still needed
                form['transaction-quantity'].value = 1;
                form['transaction-quantity'].required = true;

                // 1. Find all relevant outstanding 'Issue' transactions for partial/full return
                const outstandingIssues = transactionsData.filter(tx => 
                    tx.type === 'Issue' && 
                    tx.itemId === itemId && 
                    (tx.quantity - (tx.returnedQuantity || 0)) > 0
                ).map(tx => {
                    // Calculate outstanding quantity and current fine
                    const issued = tx.quantity || 0;
                    const returned = tx.returnedQuantity || 0;
                    const outstanding = issued - returned;
                    const currentFine = (tx.costPerUnit || 0.00) * outstanding;
                    return { ...tx, outstanding, currentFine };
                });

                // Generate the new HTML with input fields for returns
                dynamicInputContainer.innerHTML = `
                    <div class="space-y-3">
                        <h4 class="text-md font-semibold text-gray-800 border-b pb-1">Student Return Tracker (Process Partial/Full Return)</h4>
                        ${outstandingIssues.length > 0 ? `
                            <div class="max-h-60 overflow-y-auto border rounded-lg p-2 bg-gray-50 space-y-2">
                                ${outstandingIssues.map(tx => {
                                    const date = tx.timestamp ? new Date(tx.timestamp.toMillis()).toLocaleDateString() : 'N/A';
                                    const returnId = `return-qty-${tx.id}`;
                                    return `
                                        <div class="p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                                            <div class="flex justify-between items-center mb-2">
                                                <p class="font-medium text-gray-900">${tx.studentName} (SR: ${tx.studentSrNo})</p>
                                                <span class="text-xs text-yellow-700 font-semibold">Fine: ₹${tx.currentFine.toFixed(2)}</span>
                                            </div>
                                            <p class="text-xs text-gray-500 mb-2">
                                                Issued: ${date} | Total Issued: ${tx.quantity} | Returned: ${tx.returnedQuantity || 0}
                                            </p>
                                            <div class="flex space-x-2 items-end">
                                                <div class="flex-grow">
                                                    <label for="${returnId}" class="block text-xs font-medium text-gray-700">Return Qty (Max ${tx.outstanding})</label>
                                                    <input type="number" id="${returnId}" min="1" max="${tx.outstanding}" value="${tx.outstanding}"
                                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-green-500 focus:border-green-500">
                                                </div>
                                                <button type="button" 
                                                        onclick="handleProcessReturn('${tx.id}', document.getElementById('${returnId}').value)"
                                                        class="flex-shrink-0 px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-150 h-[42px]">
                                                    Return
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <p class="text-sm text-yellow-700 italic mt-2">Note: Returns update stock and recalculate the fine based on remaining outstanding quantity.</p>
                        ` : `
                            <p class="text-sm text-gray-500 p-3 bg-gray-100 rounded-lg">No open issue records found for this item.</p>
                        `}
                    </div>
                    
                    <h4 class="text-md font-semibold text-gray-800 mt-4 border-t pt-4">Manual Receive (For general stock or unlinked returns)</h4>
                    <div>
                        <label for="received-by" class="block text-sm font-medium text-gray-700">Received By / Source</label>
                        <input type="text" id="received-by" name="received-by" value="Stock Received"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                `;
            }

            openModal('transaction-modal');
        };

        /**
         * Opens the edit item modal and populates fields.
         */
        window.openEditModal = (itemId) => {
            const item = inventoryData[itemId];
            if (!item) return;

            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-part-number').value = item.partNumber;
            document.getElementById('edit-package').value = item.package;
            document.getElementById('edit-quantity').value = item.quantity;
            document.getElementById('edit-cost-per-unit').value = item.costPerUnit || '0.00'; // NEW: Cost
            document.getElementById('edit-max-quantity').value = item.maxQuantity || '';

            openModal('edit-item-modal');
        };

        /**
         * Handles tab switching in the main content area.
         */
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-yellow-500', 'text-yellow-600', 'font-semibold');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            document.getElementById(tabId + '-content').classList.remove('hidden');
            document.getElementById(tabId + '-button').classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(tabId + '-button').classList.add('border-yellow-500', 'text-yellow-600', 'font-semibold');
        };
        
        /**
         * Sets up event listeners to move focus to the next input field when Enter is pressed
         * within the Add Item modal.
         */
        function setupEnterToNextField() {
            const form = document.getElementById('add-item-form');
            if (!form) return;

            // Get all input elements in the desired order
            const inputs = [
                form.querySelector('[name="item-name"]'),
                form.querySelector('[name="part-number"]'),
                form.querySelector('[name="package"]'),
                form.querySelector('[name="total-quantity"]'),
                form.querySelector('[name="cost-per-unit"]'),
                // The max-quantity input was removed, so it's excluded here.
            ];
            
            // Filter out any null elements
            const focusableInputs = inputs.filter(input => input !== null);

            focusableInputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent form submission
                        
                        // If there's a next input, focus it
                        if (index < focusableInputs.length - 1) {
                            focusableInputs[index + 1].focus();
                        } else {
                            // If it's the last input, focus the submit button
                            form.querySelector('button[type="submit"]').focus();
                        }
                    }
                });
            });
        }

        // Initialize on load
        window.onload = () => {
            initializeFirebase();
            setupEnterToNextField(); // Call the new function to enable Enter-to-next
        };
    </script>
    <style>
        /* Custom scrollbar for aesthetics */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-thumb {
            background-color: #fcd34d; /* yellow-300 */
            border-radius: 20px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Style for the Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Message Box (Toast Notification) -->
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-transform duration-300 transform translate-x-full p-3 rounded-md shadow-lg" role="alert"></div>

    <!-- Main Application Container -->
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                <span class="text-yellow-500 mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7z" />
                        <path fill-rule="evenodd" d="M18 11v5a2 2 0 01-2 2H4a2 2 0 01-2-2v-5l4-3.582V7a1 1 0 011-1h6a1 1 0 011 1v.418L18 11zm-6 2a2 2 0 10-4 0h4z" clip-rule="evenodd" />
                    </svg>
                </span>
                DESE Electronics Inventory
            </h1>
            <div class="text-sm text-gray-500 mt-2 sm:mt-0">
                <p>User ID: <span id="current-user-id" class="font-mono text-yellow-600">Loading...</span></p>
                <p id="app-status">Status: Online</p>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="inventory-button" onclick="switchTab('inventory')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm border-yellow-500 text-yellow-600">
                    Current Inventory
                </button>
                <button id="transactions-button" onclick="switchTab('transactions')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">
                    Transaction History
                </button>
            </nav>
        </div>

        <!-- Inventory Tab Content -->
        <div id="inventory-content" class="tab-content mt-6">
            <div class="flex justify-end mb-4 space-x-3">
                <!-- Clear Inventory Button with Confirmation -->
                <button onclick="openConfirmationModal('Clear Inventory', 'Are you absolutely sure you want to permanently delete ALL inventory items? This action cannot be undone.', clearInventory)" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Clear Inventory
                </button>
                <!-- Add New Item Button -->
                <button onclick="openModal('add-item-modal')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-yellow-500 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add New Item
                </button>
            </div>
            
            <!-- Inventory Table -->
            <div class="bg-white shadow-xl rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-yellow-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Part Number</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Package</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Qty</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost/Unit (₹)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Qty</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Inventory items will be rendered here -->
                            <tr><td colspan="7" class="p-4 text-center text-gray-500">Loading inventory...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transaction History Tab Content -->
        <div id="transactions-content" class="tab-content mt-6 hidden">
            <div class="flex justify-end mb-4">
                 <!-- Clear Transactions Button with Confirmation -->
                <button onclick="openConfirmationModal('Clear Transactions', 'Are you absolutely sure you want to permanently delete ALL transaction history? This action cannot be undone.', clearTransactions)" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-1.414 7.071L10 11.586V16h4v-2.414l2.414-2.414L15.999 11l-2.828-2.828z" />
                        <path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1h2V3a1 1 0 10-2 0zM4 6a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V8a2 2 0 00-2-2h-3.382l-.724-1.447A1 1 0 0011 3H9a1 1 0 00-.894.553L7.382 6H4zM16 8H4v6h12V8z" clip-rule="evenodd" />
                    </svg>
                    Clear Transactions
                </button>
            </div>
            <div class="bg-white shadow-xl rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Part Number</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type / Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To/From</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fine (₹)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Challan</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-history-body" class="bg-white divide-y divide-gray-200">
                            <!-- Transaction records will be rendered here -->
                            <tr><td colspan="8" class="p-4 text-center text-gray-500">Loading transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Hidden Container for PDF generation -->
    <div id="pdf-container" class="hidden"></div>

    <!-- --- Modals --- -->

    <!-- Generic Confirmation Modal (New) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-40 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0 transition-opacity"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm relative">
                <button onclick="closeModal('confirmation-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.444 2.83-1.444 3.597 0l1.75 3.303a1.5 1.5 0 001.07.72l3.655.447c1.597.195 2.21 2.053 1.07 3.203l-2.673 2.766a1.5 1.5 0 00-.472 1.258l.63 3.655c.273 1.597-1.298 2.585-2.73 1.892l-3.303-1.75a1.5 1.5 0 00-1.258 0l-3.303 1.75c-1.432.693-3.003-.295-2.73-1.892l.63-3.655a1.5 1.5 0 00-.472-1.258L.797 10.772c-1.14-1.15-.527-3.008 1.07-3.203l3.655-.447a1.5 1.5 0 001.07-.72l1.75-3.303zM10 13a1 1 0 100 2 1 1 0 000-2zm0-8a1 1 0 011 1v4a1 1 0 11-2 0V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <h3 id="confirmation-modal-title" class="text-lg font-medium leading-6 text-gray-900 mt-3">Confirm Action</h3>
                    <p id="confirmation-modal-message" class="mt-2 text-sm text-gray-500">Are you sure you want to proceed?</p>
                </div>
                
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                    <button type="button" id="confirmation-modal-button" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:col-start-2 sm:text-sm">
                        Confirm Delete
                    </button>
                    <button type="button" onclick="closeModal('confirmation-modal')" class="mt-3 inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Add Item Modal -->
    <div id="add-item-modal" class="hidden fixed inset-0 z-40 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0 transition-opacity"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md relative">
                <button onclick="closeModal('add-item-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h3 class="text-xl font-bold leading-6 text-gray-900 mb-6 border-b pb-2">Add New Inventory Item</h3>
                
                <form id="add-item-form" onsubmit="handleAddItem(event)" class="space-y-4">
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="item-name" name="item-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="part-number" class="block text-sm font-medium text-gray-700">Part Number</label>
                        <input type="text" id="part-number" name="part-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="package" class="block text-sm font-medium text-gray-700">Package (e.g., DIP, SMD)</label>
                        <input type="text" id="package" name="package" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="total-quantity" class="block text-sm font-medium text-gray-700">Initial Quantity</label>
                        <input type="number" id="total-quantity" name="total-quantity" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <!-- Cost Per Unit Field -->
                    <div>
                        <label for="cost-per-unit" class="block text-sm font-medium text-gray-700">Cost/Fine Per Unit (₹)</label>
                        <input type="number" step="0.01" id="cost-per-unit" name="cost-per-unit" value="0.00" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <!-- Max Quantity field removed as requested -->
                    
                    <button type="submit" class="w-full py-3 px-4 bg-yellow-500 text-white font-semibold rounded-full shadow-md hover:bg-yellow-600 transition duration-150">
                        Add Item
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-item-modal" class="hidden fixed inset-0 z-40 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0 transition-opacity"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md relative">
                <button onclick="closeModal('edit-item-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h3 class="text-xl font-bold leading-6 text-gray-900 mb-6 border-b pb-2">Edit Inventory Item</h3>
                
                <form id="edit-item-form" onsubmit="handleEditItem(event)" class="space-y-4">
                    <input type="hidden" id="edit-item-id" name="edit-item-id">
                    <div>
                        <label for="edit-item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="edit-item-name" name="edit-item-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-part-number" class="block text-sm font-medium text-gray-700">Part Number</label>
                        <input type="text" id="edit-part-number" name="edit-part-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-package" class="block text-sm font-medium text-gray-700">Package</label>
                        <input type="text" id="edit-package" name="edit-package" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-quantity" class="block text-sm font-medium text-gray-700">Total Quantity</label>
                        <input type="number" id="edit-quantity" name="edit-quantity" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <!-- NEW: Edit Cost Per Unit Field -->
                    <div>
                        <label for="edit-cost-per-unit" class="block text-sm font-medium text-gray-700">Cost/Fine Per Unit (₹)</label>
                        <input type="number" step="0.01" id="edit-cost-per-unit" name="edit-cost-per-unit" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-max-quantity" class="block text-sm font-medium text-gray-700">Max Quantity</label>
                        <input type="number" id="edit-max-quantity" name="edit-max-quantity" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-yellow-500 text-white font-semibold rounded-full shadow-md hover:bg-yellow-600 transition duration-150">
                        Save Changes
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Transaction Modal (Issue/Receive) -->
    <div id="transaction-modal" class="hidden fixed inset-0 z-40 overflow-y-auto">
        <div class="modal-backdrop fixed inset-0 transition-opacity"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md relative">
                <button onclick="closeModal('transaction-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h3 id="transaction-modal-title" class="text-xl font-bold leading-6 text-gray-900 mb-2 border-b pb-2">Process Stock</h3>
                <p id="transaction-item-info" class="text-sm text-gray-500 mb-4"></p>

                <form id="transaction-form" onsubmit="handleTransaction(event)" class="space-y-4">
                    <input type="hidden" name="transaction-item-id">
                    <input type="hidden" name="transaction-type">

                    <div id="dynamic-transaction-input" class="space-y-4">
                        <!-- Student Name/SR No or Received By field will be injected here -->
                    </div>

                    <div>
                        <label for="transaction-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="transaction-quantity" name="transaction-quantity" required min="1" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500">
                        <p class="text-xs text-gray-500 mt-1">Note: For 'Issue' transactions, the quantity is limited by current stock. For 'Manual Receive', this is for stock replenishment.</p>
                    </div>

                    <button type="submit" id="transaction-submit-button" class="w-full py-3 px-4 bg-yellow-500 text-white font-semibold rounded-full shadow-md hover:bg-yellow-600 transition duration-150">
                        Confirm Transaction
                    </button>
                </form>
            </div>
        </div>
    </div>


</body>
</html>
